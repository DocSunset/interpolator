<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Marier Intersecting N-Spheres Interpolator</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" type="text/css" href="http://traviswest.ca/style.css">
</head>
<body>
<header id="title-block-header">
<h1 class="title">Marier Intersecting N-Spheres Interpolator</h1>
</header>
<h1 id="introduction">Introduction</h1>
<p>In sound design, digital musical instrument design, and intermedia art in general, creators often deal with complex generative systems with numerous control parameters: sound and video synthesizers and processors, simulations, and artificially intelligent agents are a few examples. These systems are often capable of producing a combinatorially immense variety of interesting behaviors (sounds, images, etc.) based on the state of their parameters. Much of the creative work of using and interacting with these systems comes down to exploring these vast spaces of possibilities, perhaps noting points of interest along the way. Eventually, entire compositions, installations, or musical instruments can be devised by selecting the paths to navigate within these spaces of possibilities.</p>
<p>A useful tool in the exploration and navigation of these spaces is preset interpolation. After manually recording points of interest in parameter space as presets, preset interpolation algorithms are used to automatically move between these predetermined a-priori interesting places, filling in the space between them with intermediate locations that are likely, by proximity, to also be interesting. This allows the user of a preset interpolation algorithm to move easily through the space of possibilities demarcated by the points of interest they record as presets, facilitating the discovery of other interesting points in space and of interesting paths through space.</p>
<p>What is especially useful about preset interpolation is that it allows the user to reframe the navigation of the control parameter space in terms of another separate space of control sources. For instance, the presets in parameter space can be associated with locations on a two dimensional map, often significantly reducing the dimensionality of navigation with an associated reduction in the difficulty of navigation. Alternatively, the control sources from a complex gestural interface can be used instead of a two dimensional map, allowing the destination space to be navigated by moving through the space of gestures afforded by the interface. These kinds of mappings are often essential in the design of digital musical instruments, and can be equally rewarding in other intermedia artistic practices.</p>
<h1 id="theory">Theory</h1>
<p>The basic operating principle of many preset interpolation algorithms, including the one presented here, is for the user to specify pairs of source-to-destination associations in the form of presets in these two spaces. As a concrete example, the user might be exploring the space of sounds produced by a synthesizer with possibly a very large number of parameters. They might explore for a while by manually configuring the synthesizer, and note several particularly interesting preset sound configurations. Then, to facilitate live performance with the synthesizer, the user may wish to control it with a graphics tablet. They can associate several locations on the tablet with different presets found earlier, and then use the preset interpolation algorithm to navigate between these presets. The tablet locations can also be thought of as presets, but located in the source space (the tablet’s control dimensions) rather than the destination space (the sound synthesizer parameters).</p>
<p>To remain unambiguous, for the rest of this exposition preset points in source space will be refered to as source vectors while preset points in destination space will be referred to as destination vectors. The word vector reflects the assumption inherent in most preset interpolation algorithms that the source and destination spaces are both vector spaces, meaning that presets can be meaningfully scaled and added together, and that there is a meaningful notion of distance between presets. A pair made of a source vector <span class="math inline">\(s\)</span> and a destination vector <span class="math inline">\(p\)</span> to which the sources in the vicinity of <span class="math inline">\(s\)</span> should be associated will be called a demonstration, <span class="math inline">\(d = \{s, p\}\)</span>. This reflects an interaction metaphor in which the user is thought to provide demonstrations of action-to-output relationships, i.e. “when I do <span class="math inline">\(s\)</span>, the interpolator should output <span class="math inline">\(p\)</span>.” The symbol <span class="math inline">\(p\)</span> is chosen for destination vectors based on the common situtation in which the destination space consists of the control parameters of some media generator such as a sound synthesizer, and to avoid collision with <span class="math inline">\(d\)</span> for a demonstration of a source-to-destination pair.</p>
<p>The basic principle of many interpolation algorithms is to interpolate between <span class="math inline">\(N\)</span> destination vectors <span class="math inline">\(p_n\)</span> producing an output vector <span class="math inline">\(y\)</span> in destination space via a weighted sum with weights given by <span class="math inline">\(\boldsymbol{w}\)</span>:</p>
<p><span class="math display">\[
y(\boldsymbol{w}) = \sum_{n = 0}^{N - 1} w_n * p_n
\]</span></p>
<p>The role of the preset interpolator is then reduced to simply producing and applying a list of weights, usually as a function of a query or cursor vector <span class="math inline">\(q\)</span> in the source space, and list <span class="math inline">\(D\)</span> of <span class="math inline">\(N\)</span> demonstrations.</p>
<p><span class="math display">\[
\boldsymbol{w}(q, D) = {w_0, w_1, w_2, ..., w_{n}} 
\]</span> <span class="math display">\[
D = \{s_0, p_0\}, \{s_1, p_1\}, \{s_2, p_2\}, ..., \{s_n, p_n\}
\]</span></p>
<h1 id="intersecting-n-spheres-interpolation">Intersecting N-Spheres Interpolation</h1>
<h2 id="description">Description</h2>
<p>Martin Marier introduced the <em>intersecting n-spheres interpolation</em> algorithm as part of his work with The Sponge, a deformable digital musical instrument which Marier has been developing for over a decade. This algorithm produces an interpolated output that is smooth (i.e. continuously differentiable), continuous, maps from any number of source dimensions to any number of destination dimensions, exactly passes through the demonstrated destination points, and locally depends only on nearby demonstrations. The algorithm also imposes no constraints on the placement of source and destination presets, unlike other algorithms which might require points to be evenly distributed or quantized to a grid. Furthermore, the algorithm allows for the position of presets to be dynamically varied in real-time, allowing the possibility for higher-level mappings such as navigating destination presets for the preset interpolation system itself using a higher-level preset interpolator.</p>
<p>Intersecting n-spheres interpolation produces weights for a weighted sum according to the following procedure. In summary, for each demonstration two circles are drawn: one centered on the source vector of the demonstration, and one centered on the query vector (again in source space). The radius of either circle is given by the distance from the circle’s center point (either the query vector or the source vector in a demonstration) to its nearest neighbour in source space (which may again be either the query point or a source vector in a demonstration). The weight for each demonstration is given by the ratio of the area of the circle centered on the demonstration’s source vector, and the area of the intersection of that circle with the circle centered on the query point. In a practical implementation, the procedure in full proceeds as follows.</p>
<p>Given a query point <span class="math inline">\(q\)</span>, and a list of demonstrations consisting of <span class="math inline">\(N\)</span> points in source space <span class="math inline">\(s_n\)</span> paired with the same number of points in destination space <span class="math inline">\(p_n\)</span>:</p>
<ol type="1">
<li><p>Determine the distance <span class="math inline">\(d_n\)</span> from each demonstrated source point <span class="math inline">\(s_n\)</span> to the cursor point <span class="math inline">\(q\)</span>. At the same time, search for the nearest neighbour of <span class="math inline">\(q\)</span> and record its distance from <span class="math inline">\(q\)</span> as <span class="math inline">\(r_q\)</span>.</p></li>
<li><p>For every point demonstrated point in source space <span class="math inline">\(s_n\)</span>, calculate and record the distance <span class="math inline">\(r_n\)</span> from that point to its nearest neighbour in source space (not including <span class="math inline">\(q\)</span>).</p></li>
<li><p>The weight <span class="math inline">\(w_n\)</span> associated with the destination vector <span class="math inline">\(p_n\)</span> of the <span class="math inline">\(n\)</span>th demonstration is given by <span class="math inline">\(A_x(r_q, min(r_n, r_q), d_n) / A(r_n)\)</span> where <span class="math inline">\(A\)</span> is the area of the circle centered on <span class="math inline">\(s_n\)</span> with radius <span class="math inline">\(r_n\)</span>, and where <span class="math inline">\(A_x\)</span> is the area of the intersection of two circles:</p></li>
</ol>
<ul>
<li>The circle centered on <span class="math inline">\(s_n\)</span> with radius given by the minimum between <span class="math inline">\(r_n\)</span> or <span class="math inline">\(r_q\)</span>,</li>
<li>and the circle centered on <span class="math inline">\(q\)</span> with radius <span class="math inline">\(r_q\)</span>,</li>
<li>with the circles defined to lay on the same plane, which may be any plane passing through both <span class="math inline">\(s_n\)</span> and <span class="math inline">\(q\)</span>.</li>
</ul>
<p>Note that <span class="math inline">\(A_x\)</span> depends only on the radii of the two circles <span class="math inline">\(r_q\)</span> and <span class="math inline">\(r_n\)</span>, and the distance <span class="math inline">\(d_n\)</span> between them.</p>
<ol start="4" type="1">
<li><p>Calculate the interpolated output <span class="math inline">\(p\)</span> in destination space as the weighted sum of demonstrated outputs <span class="math inline">\(p_n\)</span>.</p></li>
<li><p>Normalize the weights (or equivalently the weighted sum) so that their sum is equal to one by dividing each weight <span class="math inline">\(w_n\)</span> by the mean of all the weights <span class="math inline">\(\mu = \frac{1}{N}\sum_{n = 0}^{N - 1} w_n\)</span></p></li>
</ol>
<p><span class="math inline">\(A_x\)</span> is given by the following function:</p>
<p><span class="math display">\[
\begin{aligned}
A_x(R, r, d) &amp;= r^2 cos^(-1) ( \frac{d^2 + r^2 - R^2}{2dr} ) \\
             &amp;+ R^2 cos^(-1) ( \frac{d^2 + R^2 - r^2}{2dR} ) \\
             &amp;- \frac{\sqrt{(-d + r + R)(d + r - R)(d - r + R)(d + r + R)}}{2}
\end{aligned}
\]</span></p>
<p>And <span class="math inline">\(A\)</span> is given by the usual equation for the area of a circle: <span class="math display">\[
A(r) = \pi r^2
\]</span></p>
<p>The algorithm, despite its name, actually doesn’t involve any n-spheres. Intead, 2D circles are used, simplifying the algorithm while producing results that “are predictable and feel natural to the user” according to Marier.</p>
<h2 id="implementation">Implementation</h2>
<p>The weighted sum in Marier’s algorithm implies that the destination space is some kind of vector space, while the requirement for a notion of distance implies that the source space is a normed vector space, most often an Euclidean vector space. These assumptions are represented in the implementation by the assumption that the templated <code>PVector</code> for the destination space will have an operator for multiplication by a scalar, and addition of two vectors, and that the templated <code>SVector</code> for the source space will have the same two operators as well as a method <code>norm</code> that returns the length of a vector.</p>
<p>The functions to compute the weight for a single destination vector are generally straightforward to implement based on the equations above.</p>
<p>One necessary quirk: when the interpolator is used with <code>float</code> scalars, the argument to the <code>acos</code> and <code>sqrt</code> calls sometimes fall just outside the domain of the functions. Boundary conditions are checked if <code>Scalar</code> is <code>float</code>: in testing, the <code>acos</code> args only ever fell at or slightly above <code>1.0f</code>, so this is the only condition which is addressed by the boundary check for these args.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;weight functions&#39;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>Scalar circle_circle_intersection_area<span class="op">(</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> Scalar<span class="op">&amp;</span> R<span class="op">,</span> </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> Scalar<span class="op">&amp;</span> r<span class="op">,</span> </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> Scalar<span class="op">&amp;</span> d<span class="op">)</span> <span class="at">const</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    Scalar d2 <span class="op">=</span> d <span class="op">*</span> d<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    Scalar r2 <span class="op">=</span> r <span class="op">*</span> r<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    Scalar R2 <span class="op">=</span> R <span class="op">*</span> R<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    Scalar two_d <span class="op">=</span> <span class="op">(</span>Scalar<span class="op">)</span><span class="dv">2</span> <span class="op">*</span> d<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    Scalar arg1 <span class="op">=</span> <span class="op">(</span>d2 <span class="op">+</span> r2 <span class="op">-</span> R2<span class="op">)/(</span>two_d <span class="op">*</span> r<span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    Scalar arg2 <span class="op">=</span> <span class="op">(</span>d2 <span class="op">+</span> R2 <span class="op">-</span> r2<span class="op">)/(</span>two_d <span class="op">*</span> R<span class="op">);</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    Scalar arg3 <span class="op">=</span> <span class="op">(-</span>d<span class="op">+</span>r<span class="op">+</span> R<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>d<span class="op">+</span>r<span class="op">-</span>R<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>d<span class="op">-</span>r<span class="op">+</span>R<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>d<span class="op">+</span>r<span class="op">+</span>R<span class="op">);</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    Scalar a<span class="op">,</span> b<span class="op">,</span> c<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span><span class="bu">std::</span>is_same_v<span class="op">&lt;</span>Scalar<span class="op">,</span> <span class="dt">float</span><span class="op">&gt;)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>arg1 <span class="op">&gt;</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span> a <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> a <span class="op">=</span> r2 <span class="op">*</span> <span class="bu">std::</span>acos<span class="op">(</span>arg1<span class="op">);</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>arg2 <span class="op">&gt;</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span> b <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> b <span class="op">=</span> R2 <span class="op">*</span> <span class="bu">std::</span>acos<span class="op">(</span>arg2<span class="op">);</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>arg3 <span class="op">&lt;</span> <span class="fl">0.0</span><span class="bu">f</span><span class="op">)</span> c <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> c <span class="op">=</span> <span class="bu">std::</span>sqrt<span class="op">(</span>arg3<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        a <span class="op">=</span> r2 <span class="op">*</span> <span class="bu">std::</span>acos<span class="op">(</span>arg1<span class="op">);</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        b <span class="op">=</span> R2 <span class="op">*</span> <span class="bu">std::</span>acos<span class="op">(</span>arg2<span class="op">);</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> <span class="bu">std::</span>sqrt<span class="op">(</span>arg3<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>Scalar<span class="op">)</span><span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b <span class="op">-</span> c<span class="op">;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>Scalar circle_area<span class="op">(</span><span class="at">const</span> Scalar<span class="op">&amp;</span> r<span class="op">)</span> <span class="at">const</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> Scalar pi <span class="op">=</span> <span class="fl">3.14159265358979323846264338327950288419716939937510582097494459230781640628620899863</span><span class="op">;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pi <span class="op">*</span> r <span class="op">*</span> r<span class="op">;</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>Scalar intersecting_spheres_weight<span class="op">(</span><span class="at">const</span> Scalar<span class="op">&amp;</span> R<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> r<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> d<span class="op">)</span> <span class="at">const</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> circle_circle_intersection_area<span class="op">(</span>R<span class="op">,</span> r<span class="op">,</span> d<span class="op">)</span> <span class="op">/</span> circle_area<span class="op">(</span>r<span class="op">);</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>Step 2 above is an instance of the “all nearest neighbours” problem. We are given a set of points (the demonstrated points in the source space plus the cursor point) and for each point <span class="math inline">\(p\)</span> we need to determine the nearest other point in the space <span class="math inline">\(p_{\text{nearest}}\)</span>, which will be used to determine the radius of the circle associated with <span class="math inline">\(p\)</span>.</p>
<p>Based on a cursory and incomplete review of the literature, efficient algorithms appear to exist which solve the all nearest neighbours problem in <span class="math inline">\(O(n\log n)\)</span> time, or even in <span class="math inline">\(O(n)\)</span> time if certain constraints are met. Unfortunately, comprehending (let alone implementing) the linear time algorithms for this problem is non-trivial, so we opt to use a simpler algorithm until such time as it becomes clear that optimization is necessary.</p>
<p>If we assume that the demonstrations may change at any time, then updating any of the points in source space including the cursor point always requires the nearest neighbour problem to be solved anew, because the nearest neighbour of the updated point and any point that it was previously the nearest neighbour of it all have to be updated. Because the position of the cursor point is assumed to change whenever the interpolator is queried, this means that the nearest neighbour problem must be solved for every query. The trivial implementation used here (as well as in Marier’s original Supercollider implementation of the algorithm) solves this problem with <span class="math inline">\(O(n^2)\)</span> time complexity using plain old brute force; the distance from every point to every other point is calculated, and the nearest neighbour is found as the point with the least calculated distance value. In Marier’s practice this <span class="math inline">\(O(n^2)\)</span> time complexity hasn’t been reported as an issue, presumably because the number of data points has always been reasonably low.</p>
<p>However, if we assume that the demonstrations have not changed since the last query, then it should be unnecessary to solve the all nearest neighbours problem. Instead, the weights can be generated in linear time, since only the distance from the query point to each demonstration needs to be calculated.</p>
<p>In either case, the query function is logically pure. The result depends only on the demonstration and query points. The output consists of the weighted sum, but also the weights, distances, and radii calculated along the way. These latter values are useful for interactive applications such as the OpenGL demo presented later, since they allow the inner workings of the algorithm to be rendered to the user.</p>
<p>The interpolation function is implemented as a class for a few reasons. This allows the metadata and parameter structures unique to this interpolator to be accessible through the type system whenever you have an instance of this interpolator. The Intersecting N-Spheres algorithm doesn’t have any parameters, but other algorithms will require these, so a <code>Para</code> structure is declared to provide a consistent interface. The class is also used as the interface to set interpolator-specific global parameters, such as the flag <code>dynamic_demos</code> that is used to decide whether to skip the nearest-neighbours problem. Finally, the class is used to store interpolator-specific global outputs, such as the <code>r_q</code> radius calculated in the N-Spheres algorithm.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;interpolators&#39;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> IntersectingNSpheres</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Meta <span class="op">{</span> Scalar r <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> d <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> w <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Para <span class="op">{</span> <span class="co">/* none */</span> <span class="op">};</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> dynamic_demos <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mutable</span> Scalar r_q<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>weight functions<span class="op">}</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> DemoList<span class="op">,</span> <span class="kw">typename</span> MetaList<span class="op">,</span> <span class="kw">typename</span> ParaList<span class="op">&gt;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    PVector query<span class="op">(</span><span class="at">const</span> SVector<span class="op">&amp;</span> q<span class="op">,</span> <span class="at">const</span> DemoList<span class="op">&amp;</span> demo<span class="op">,</span> <span class="at">const</span> ParaList<span class="op">&amp;</span> para<span class="op">,</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            MetaList<span class="op">&amp;</span> meta<span class="op">,</span> PVector<span class="op">&amp;</span> weighted_sum<span class="op">)</span> <span class="at">const</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        Scalar sum_of_weights <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>demo<span class="op">.</span>size<span class="op">()</span> <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>demo<span class="op">.</span>size<span class="op">()</span> <span class="op">!=</span> meta<span class="op">.</span>size<span class="op">())</span> <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// step 1</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>calculate radius r_q <span class="kw">and</span> distances d_n<span class="op">}</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">std::</span>size_t<span class="op"> </span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> demo<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">const</span> SVector<span class="op">&amp;</span> <span class="va">s_n</span> <span class="op">=</span> demo<span class="op">[</span>i<span class="op">].</span>s<span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">const</span> PVector<span class="op">&amp;</span> p_n <span class="op">=</span> demo<span class="op">[</span>i<span class="op">].</span>p<span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>            Scalar<span class="op">&amp;</span> r_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>r<span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>            Scalar<span class="op">&amp;</span> d_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>d<span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            Scalar<span class="op">&amp;</span> w_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>w<span class="op">;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>dynamic_demos<span class="op">)</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>                <span class="co">// step 2</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                <span class="er">@</span><span class="op">{</span>calculate the radius r_n<span class="op">}</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">((</span>r_q <span class="op">+</span> r_n<span class="op">)</span> <span class="op">&lt;</span> d_n<span class="op">)</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>                w_n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span> <span class="co">// the circles are non-intersecting</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>            <span class="co">// step 3</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>            w_n <span class="op">=</span> intersecting_spheres_weight<span class="op">(</span>r_q<span class="op">,</span> r_n <span class="op">&lt;</span> d_n <span class="op">?</span> r_n <span class="op">:</span> d_n<span class="op">,</span> d_n<span class="op">);</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>            <span class="co">// step 4</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>            weighted_sum <span class="op">=</span> weighted_sum <span class="op">+</span> w_n <span class="op">*</span> p_n<span class="op">;</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>            sum_of_weights <span class="op">=</span> sum_of_weights <span class="op">+</span> w_n<span class="op">;</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// step 5</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Meta<span class="op">&amp;</span> m <span class="op">:</span> meta<span class="op">)</span> <span class="op">{</span> m<span class="op">.</span>w <span class="op">=</span> m<span class="op">.</span>w <span class="op">/</span> sum_of_weights<span class="op">;</span> <span class="op">}</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        weighted_sum <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">/</span> sum_of_weights<span class="op">)</span> <span class="op">*</span> weighted_sum<span class="op">;</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> name <span class="op">=</span> <span class="st">&quot;intersecting n-spheres&quot;</span><span class="op">;</span></span>
<span id="cb2-59"><a href="#cb2-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> vert_name <span class="op">=</span> <span class="st">&quot;intersecting n-spheres vertex shader&quot;</span><span class="op">;</span></span>
<span id="cb2-60"><a href="#cb2-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> vert <span class="op">=</span></span>
<span id="cb2-61"><a href="#cb2-61" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;\</span></span>
<span id="cb2-62"><a href="#cb2-62" aria-hidden="true" tabindex="-1"></a><span class="st">        #version 300 es</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-63"><a href="#cb2-63" aria-hidden="true" tabindex="-1"></a><span class="st">        in vec2 vertPos;</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-64"><a href="#cb2-64" aria-hidden="true" tabindex="-1"></a><span class="st">        out vec4 colour;</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-65"><a href="#cb2-65" aria-hidden="true" tabindex="-1"></a><span class="st">        const vec4 white = vec4(1.0);</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-66"><a href="#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-67"><a href="#cb2-67" aria-hidden="true" tabindex="-1"></a><span class="st">        void main()</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-68"><a href="#cb2-68" aria-hidden="true" tabindex="-1"></a><span class="st">        {</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-69"><a href="#cb2-69" aria-hidden="true" tabindex="-1"></a><span class="st">            colour = white;</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-70"><a href="#cb2-70" aria-hidden="true" tabindex="-1"></a><span class="st">            gl_Position = vec4(vertPos, 0.0, 1.0);</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-71"><a href="#cb2-71" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-72"><a href="#cb2-72" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;</span><span class="op">;</span></span>
<span id="cb2-73"><a href="#cb2-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-74"><a href="#cb2-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> frag_name <span class="op">=</span> <span class="st">&quot;intersecting n-spheres fragment shader&quot;</span><span class="op">;</span></span>
<span id="cb2-75"><a href="#cb2-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="kw">constexpr</span> <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> frag <span class="op">=</span></span>
<span id="cb2-76"><a href="#cb2-76" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;\</span></span>
<span id="cb2-77"><a href="#cb2-77" aria-hidden="true" tabindex="-1"></a><span class="st">        #version 300 es</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-78"><a href="#cb2-78" aria-hidden="true" tabindex="-1"></a><span class="st">        #ifdef GL_ES</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-79"><a href="#cb2-79" aria-hidden="true" tabindex="-1"></a><span class="st">        precision highp float</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-80"><a href="#cb2-80" aria-hidden="true" tabindex="-1"></a><span class="st">        #endif</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-81"><a href="#cb2-81" aria-hidden="true" tabindex="-1"></a><span class="st">        in vec4 colour;</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-82"><a href="#cb2-82" aria-hidden="true" tabindex="-1"></a><span class="st">        out vec4 fragColour;</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-83"><a href="#cb2-83" aria-hidden="true" tabindex="-1"></a><span class="st">        </span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-84"><a href="#cb2-84" aria-hidden="true" tabindex="-1"></a><span class="st">        void main()</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-85"><a href="#cb2-85" aria-hidden="true" tabindex="-1"></a><span class="st">        {</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-86"><a href="#cb2-86" aria-hidden="true" tabindex="-1"></a><span class="st">            fragColour = colour;</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-87"><a href="#cb2-87" aria-hidden="true" tabindex="-1"></a><span class="st">        }</span><span class="sc">\n</span><span class="st">\</span></span>
<span id="cb2-88"><a href="#cb2-88" aria-hidden="true" tabindex="-1"></a><span class="st">    &quot;</span><span class="op">;</span></span>
<span id="cb2-89"><a href="#cb2-89" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb2-90"><a href="#cb2-90" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>One quirk of the above implementation is that the output (<code>weighted_sum</code>) is passed by variable. This is necessary to avoid having to initialize <code>weighted_sum</code> to zero. By leaving this responsibility to the caller, the implementation of the interpolator is more generic, only imposing the need for operators for addition and multiplication by a scalar, and <code>size()</code> member and index operator for the lists. In other words, the interpolator doesn’t know how to initialize a <code>PVector</code>, which could be a raw float array, a complicated linear algebra library vector, or anything else, as long as it has addition and multiplication by a scalar. Since <code>PVector</code> is so generic, the implementation of the interpolator can’t make assumptions about how to construct or initialize it.</p>
<h3 id="implementation-details">Implementation details</h3>
<p>Although every demonstration will be visited in the main loop of the query function, the radius of the query point has to be known in advance in order to calculate the weight associated with each demonstration. While searching for the query point’s nearest neighbour, it is convenient to also cache the distance from the query point to every demonstration.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;calculate radius r_q and distances d_n&#39;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>r_q <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>max<span class="op">();</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">std::</span>size_t<span class="op"> </span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> demo<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> SVector<span class="op">&amp;</span> <span class="va">s_n</span> <span class="op">=</span> demo<span class="op">[</span>i<span class="op">].</span>s<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> PVector<span class="op">&amp;</span> p_n <span class="op">=</span> demo<span class="op">[</span>i<span class="op">].</span>p<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    Scalar<span class="op">&amp;</span> d_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>d<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    Scalar<span class="op">&amp;</span> w_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>w<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    d_n <span class="op">=</span> <span class="op">(</span><span class="va">s_n</span> <span class="op">-</span> q<span class="op">).</span>norm<span class="op">();</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>d_n <span class="op">&lt;</span> r_q<span class="op">)</span> r_q <span class="op">=</span> d_n<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>avoid numerical imprecision issues<span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>As the query point approaches the position of a demonstrated point, the size of both <span class="math inline">\(A_x\)</span> and <span class="math inline">\(A\)</span> get smaller and smaller, which would likely lead to numerical instability when calculating the weight <span class="math inline">\(A_x/A\)</span>. For this reason, an arbitrary amount of sloppiness is introduced into the determination of whether the query point exactly coincides with a demonstrated point, so that the ratio <span class="math inline">\(A_x/A\)</span> will not be calculated if the query is too close to a demonstration. Instead, if the query is close enough to the demonstration then the exact value of the demonstration is returned and further calculation of the weighted sum is short-circuited. This condition is checked while calculating the distance from the current source vector to the query point, which takes place just before searching for the radius of the circle centered on the source vector. Although this also short circuits the recalculation of all the metadata calculated during a query, it is presumed that this condition will be approached gradually and encountered rarely and briefly, and that the metadata will therefore be close enough for practical purposes.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;avoid numerical imprecision issues&#39;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> Scalar an_arbitrary_slop_factor <span class="op">=</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>epsilon<span class="op">()</span> <span class="op">*</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>d_n <span class="op">&lt;=</span> an_arbitrary_slop_factor<span class="op">)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    w_n <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    weighted_sum <span class="op">=</span> p_n<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>Finding the radius of the circle centered on the demonstration <code>demo</code> is done by brute force search, as mentioned above. The distance from <code>demo</code> to ever other demonstration is checked, and the least distance is recorded. Finally, the distance from the demonstration to the query point is checked, and this is used if it is less than the distance from the demonstration to the nearest other demonstration.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;calculate the radius r_n&#39;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>r_n <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>max<span class="op">();</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="at">const</span> Demo<span class="op">&amp;</span> demo2 <span class="op">:</span> demo<span class="op">)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>demo<span class="op">[</span>i<span class="op">].</span>id <span class="op">==</span> demo2<span class="op">.</span>id<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span> <span class="co">// demo cannot be its own nearest neighbour</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    Scalar r <span class="op">=</span> <span class="op">(</span><span class="va">s_n</span> <span class="op">-</span> demo2<span class="op">.</span>s<span class="op">).</span>norm<span class="op">();</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>r <span class="op">&lt;</span> r_n<span class="op">)</span> r_n <span class="op">=</span> r<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h1 id="inverse-distance-interpolator">Inverse Distance Interpolator</h1>
<p>Another simple interpolation algorithm is presented here. This algorithm is one of the earliest proposed in the literature, with roots in the early 1980s with the SYTER system developed at GRM. The implementation below follows the presentation by Todoroff and colleagues in their 2009 paper at the International Computer Music Conference, “1-d, 2-d and 3-d interpolation tools for max/msp/jitter.” Despite the name of their paper, the algorithm naturally extends to arbitrary source and destination spatial dimensions.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;interpolators&#39;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> InverseDistance <span class="co">/* after e.g. Todoroff 2009 ICMC */</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Meta <span class="op">{</span> Scalar d <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> w <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Para </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        Scalar power <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span>      d_min <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>min<span class="op">()</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span>      r_min <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span>      r <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> DemoList<span class="op">,</span> <span class="kw">typename</span> MetaList<span class="op">,</span> <span class="kw">typename</span> ParaList<span class="op">&gt;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    PVector query<span class="op">(</span><span class="at">const</span> SVector<span class="op">&amp;</span> q<span class="op">,</span> <span class="at">const</span> DemoList<span class="op">&amp;</span> demo<span class="op">,</span> <span class="at">const</span> ParaList<span class="op">&amp;</span> para<span class="op">,</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            MetaList<span class="op">&amp;</span> meta<span class="op">,</span> PVector<span class="op">&amp;</span> weighted_sum<span class="op">)</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        Scalar sum_of_weights <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>size_t<span class="op"> </span>i<span class="op">,</span> N <span class="op">=</span> demo<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>N <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>N <span class="op">!=</span> meta<span class="op">.</span>size<span class="op">())</span> <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>N<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span>  <span class="op">{</span> meta<span class="op">[</span>i<span class="op">].</span>d <span class="op">=</span> <span class="op">(</span>demo<span class="op">[</span>i<span class="op">].</span>s <span class="op">-</span> q<span class="op">).</span>norm<span class="op">();</span> <span class="op">}</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>N<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span>  </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span> </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">auto</span> base <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>meta<span class="op">[</span>i<span class="op">].</span>d <span class="op">-</span> para<span class="op">[</span>i<span class="op">].</span>r_min<span class="op">,</span> para<span class="op">[</span>i<span class="op">].</span>d_min<span class="op">);</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            meta<span class="op">[</span>i<span class="op">].</span>w <span class="op">=</span> para<span class="op">[</span>i<span class="op">].</span>r <span class="op">/</span> pow<span class="op">(</span> base<span class="op">,</span> para<span class="op">[</span>i<span class="op">].</span>power<span class="op">);</span> </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>N<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span>  <span class="op">{</span> weighted_sum <span class="op">=</span> weighted_sum <span class="op">+</span> meta<span class="op">[</span>i<span class="op">].</span>w <span class="op">*</span> demo<span class="op">[</span>i<span class="op">].</span>p<span class="op">;</span> <span class="op">}</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Meta<span class="op">&amp;</span> m <span class="op">:</span> meta<span class="op">)</span> <span class="op">{</span> sum_of_weights <span class="op">=</span> sum_of_weights <span class="op">+</span> m<span class="op">.</span>w<span class="op">;</span> <span class="op">}</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Meta<span class="op">&amp;</span> m <span class="op">:</span> meta<span class="op">)</span> <span class="op">{</span> m<span class="op">.</span>w <span class="op">=</span> m<span class="op">.</span>w <span class="op">/</span> sum_of_weights<span class="op">;</span> <span class="op">}</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> weighted_sum <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">/</span> sum_of_weights<span class="op">)</span> <span class="op">*</span> weighted_sum<span class="op">;</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h1 id="interpolators-summary-and-library">Interpolators Summary and Library</h1>
<p>The interpolators are all gathered inside of a shared <code>struct</code>. This is done in order to propagate the template parameters for the <code>Scalar, ID, SVector,</code> and <code>PVector</code> types to all the interpolators so that in case the calling program wants to use the same types for all interpolators they only need to declare them once. The demonstration type, <code>struct Demo</code>, is also declared at this level.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @#&#39;interpolator/marier_spheres.h&#39;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef MARIER_SPHERES_INTERPOLATOR_H</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MARIER_SPHERES_INTERPOLATOR_H</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;limits&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;cstddef&gt;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Scalar<span class="op">,</span> <span class="kw">typename</span> ID<span class="op">,</span> <span class="kw">typename</span> SVector<span class="op">,</span> <span class="kw">typename</span> PVector<span class="op">&gt;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Interpolators</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Demo <span class="op">{</span> ID id<span class="op">;</span> SVector s<span class="op">;</span> PVector p<span class="op">;</span> <span class="op">};</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>interpolators<span class="op">}</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h1 id="demonstration">Demonstration</h1>
<p>An demo program is provided in the repository that is helpful in exploring the subtleties of the different algorithms presented here. The program randomly generates a handful of source-destination demonstrations, and draw an image by systematically querying the source space. As well as producing images that might offer some intuition about the topology of the interpolated output, this will also serve as a reasonable benchmark for the efficiency of the implementation and compilation environment, if the number of pixels in the image is large enough.</p>
<p>For example, the initial implementation of the Intersecting N-Spheres interpolator, when compiled with optimizations enabled and run on a circa 2012 ultrabook processor, could process about 15000 queries per second with 5 demonstrations, about 5000 per second with 15 demonstrations, 2200 with 25 demonstrations, and 1200 with 35 demonstrations. As per the quadratic time complexity of this implementation, the number of queries processed per second decreases by a multiplicative factor as the number of demonstrations increases linearly. Performance on larger datasets is improved significantly, as expected, if the quadratic-time all nearest neighbours problem is avoided by assuming that demonstrations are unchanged between interpolations. Performance may have changed significantly since that initial benchmark, due to a combination of changes in the overall runtime (the original benchmark didn’t use SDL or the GPU for instance) and the implementation itself. But the numbers given provide some indication of the relative performance of different interpolator algorithms.</p>
<p>The demo program requires SDL2, and is designed to be compiled as a native or WASM-based web application.</p>
<h2 id="usage">Usage</h2>
<p>This section still needs to be written.</p>
<h2 id="implementation-1">Implementation</h2>
<p>The starring roles are played by the interpolation algorithms, declared in a tuple alongside the lists of metadata and parameters. The source space is normalized 2D screen coordinates. The destination space is color. The colour interpolations are performed in <a href="https://doi.org/10.1364/OE.25.015131">J_zA_zB_z colour space</a>, a colour representation that is designed to provide the best balance of perceptual uniformity and iso-hue linearity. This is meant to ensure that the image produced reflects the topology of the interpolation rather than the non-linearity of sRGB colour space. The details of the conversion from RGB (assumed sRGB) through CIE XYZ to J_zA_zB_z colour space and back are given below after the presentation of the demo program.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;types&#39;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> Scalar <span class="op">=</span> <span class="dt">float</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> ID <span class="op">=</span> <span class="dt">unsigned</span> <span class="dt">int</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> Vec2 <span class="op">=</span> Eigen<span class="op">::</span>Vector2f<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> RGBVec <span class="op">=</span> Eigen<span class="op">::</span>Vector3f<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> CIEXYZVec <span class="op">=</span> Eigen<span class="op">::</span>Vector3f<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> JzAzBzVec <span class="op">=</span> Eigen<span class="op">::</span>Vector3f<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> Interpolator <span class="op">=</span> Interpolators<span class="op">&lt;</span>Scalar<span class="op">,</span> ID<span class="op">,</span> Vec2<span class="op">,</span> JzAzBzVec<span class="op">&gt;;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;declare interpolators&#39;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#define INTERPOLATOR</span><span class="op">(</span>type<span class="op">,</span><span class="pp"> </span><span class="op">...)</span><span class="pp"> </span><span class="bu">std::</span>make_tuple<span class="op">(</span>type<span class="op">{},</span><span class="pp"> </span><span class="bu">std::</span>vector<span class="op">&lt;</span>type<span class="op">::</span>Meta<span class="op">&gt;{},</span><span class="pp"> </span><span class="bu">std::</span>vector<span class="op">&lt;</span>type<span class="op">::</span>Para<span class="op">&gt;{},</span><span class="pp"> </span>type<span class="op">::</span>Para<span class="op">{</span><span class="ot">__VA_ARGS__</span><span class="op">})</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> interpolators <span class="op">=</span> <span class="bu">std::</span>make_tuple</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="op"> </span>       <span class="op">(</span> INTERPOLATOR<span class="op">(</span>Interpolator<span class="op">::</span>IntersectingNSpheres<span class="op">)</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> INTERPOLATOR<span class="op">(</span>Interpolator<span class="op">::</span>InverseDistance<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="fl">0.001</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">)</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>An overview of the program shows a typical event-loop driven SDL application. In order to accomodate both Emscripten/web and native SDL build targets, the loop is placed in a seperate function <code>void loop()</code> that can be called by the browser’s event loop or the main function loop depending on the platform.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @#&#39;examples/interpolators_demo.cpp&#39;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>includes<span class="op">}</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>types<span class="op">}</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>declare interpolators<span class="op">}</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>colour conversions<span class="op">}</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Context</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>globally visible state<span class="op">}</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> context<span class="op">;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>helper functions<span class="op">}</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> loop <span class="op">()</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>poll event queue <span class="kw">and</span> handle events<span class="op">}</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>context<span class="op">.</span>redraw<span class="op">)</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>draw <span class="kw">and</span> refresh screen<span class="op">}</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>setup<span class="op">}</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co">//#ifdef __EMSCRIPTEN__</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="co">//    emscripten_set_main_loop(loop, -1, 1);</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="co">//#else</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="co">//    while (not context.quit)</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co">//    {</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="co">//        loop();</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="co">//        SDL_Delay(33);</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="co">//    }</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="co">//#endif</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EXIT_SUCCESS<span class="op">;</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h3 id="drawing">Drawing</h3>
<p>The drawing routine is deeply embedded in several layers of book keeping: finding the active interpolator within the tuple, timing the drawing routine, and finally the drawing routine itself.</p>
<p>The main loop of the program clears the screen, draws, and then presents the drawing. Only one interpolator is drawn at a time (the active interpolator).</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;globally visible state&#39;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> active_interpolator <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>In order to find the <code>active_interpolator</code>, it is necessary to iterate over the tuple of interpolators using a C++17 fold expression in a generic lambda that calls the draw function and is applied over the whole tuple; this is the best way I could think of to iterate over the tuple, and is necessary as a consequence of the decision to use a tuple and avoid runtime polymorphism. This is by no means the only way to achieve this (there are probably better ways), but it’s convenient not to have to write a base class for interpolators at the stage of development I’m currently at.</p>
<p>The iteration happens in the main loop. An index <code>i</code> initialized to 0. Each call to the draw function is passed this index, and one interpolator. If the index doesn’t match the <code>active_interpolator</code>, then the function returns without doing anything. In this way only the active interpolator is drawn.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;draw and refresh screen&#39;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>apply<span class="op">([&amp;](</span><span class="kw">auto</span><span class="op">&amp;</span> <span class="op">...</span> tuples<span class="op">)</span> <span class="op">{((</span>draw<span class="op">(</span>i<span class="op">,</span> tuples<span class="op">)),</span> <span class="op">...);},</span> interpolators<span class="op">);</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>context<span class="op">.</span>redraw <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;helper functions&#39;</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> T<span class="op">&gt;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> draw<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span><span class="op">&amp;</span> i<span class="op">,</span> T<span class="op">&amp;</span> tup<span class="op">)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i<span class="op">++</span> <span class="op">!=</span> context<span class="op">.</span>active_interpolator<span class="op">)</span> <span class="cf">return</span><span class="op">;</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span><span class="op">&amp;</span> interpolator <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span><span class="op">&amp;</span> meta <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span><span class="op">&amp;</span> para <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>run the timer <span class="kw">and</span> draw<span class="op">}</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>The drawing routine itself is couched in another layer, which simply runs a timer while the drawing takes place to provide a simple performance benchmark.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;run the timer and draw&#39;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>a flag to keep track of <span class="at">static</span> demos optimization<span class="op">}</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> start <span class="op">=</span> <span class="bu">std::</span>chrono<span class="bu">::</span>high_resolution_clock<span class="bu">::</span>now<span class="op">();</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> xpix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> xpix <span class="op">&lt;</span> context<span class="op">.</span>w<span class="op">;</span> <span class="op">++</span>xpix<span class="op">)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> ypix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ypix <span class="op">&lt;</span> context<span class="op">.</span>h<span class="op">;</span> <span class="op">++</span>ypix<span class="op">)</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>draw one pixel<span class="op">}</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> stop <span class="op">=</span> <span class="bu">std::</span>chrono<span class="bu">::</span>high_resolution_clock<span class="bu">::</span>now<span class="op">();</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> usec <span class="op">=</span> <span class="bu">std::</span>chrono<span class="bu">::</span>duration_cast<span class="op">&lt;</span><span class="bu">std::</span>chrono<span class="bu">::</span>microseconds<span class="op">&gt;(</span>stop <span class="op">-</span> start<span class="op">).</span>count<span class="op">();</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>cout<span class="op"> &lt;&lt;</span> i<span class="op">-</span><span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;: Generated &quot;</span> <span class="op">&lt;&lt;</span> context<span class="op">.</span>w <span class="op">*</span> context<span class="op">.</span>h <span class="op">&lt;&lt;</span> <span class="st">&quot; interpolations in &quot;</span> <span class="op">&lt;&lt;</span> usec <span class="op">&lt;&lt;</span> <span class="st">&quot; microseconds</span><span class="sc">\n</span><span class="st">&quot;</span> </span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;&lt;</span> <span class="st">&quot;About &quot;</span> <span class="op">&lt;&lt;</span> <span class="dv">1000000</span> <span class="op">*</span> context<span class="op">.</span>w <span class="op">*</span> context<span class="op">.</span>h <span class="op">/</span> usec <span class="op">&lt;&lt;</span> <span class="st">&quot; interpolations per second&quot;</span> </span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>Finally, the drawing routine itself:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;draw one pixel&#39;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> q <span class="op">=</span> Vec2<span class="op">{</span>xpix<span class="op">/(</span>Scalar<span class="op">)</span>context<span class="op">.</span>w<span class="op">,</span> ypix<span class="op">/(</span>Scalar<span class="op">)</span>context<span class="op">.</span>h<span class="op">};</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>JzAzBzVec interpolated_jab<span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>interpolator<span class="op">.</span>query<span class="op">(</span>q<span class="op">,</span> context<span class="op">.</span>demo<span class="op">,</span> para<span class="op">,</span> meta<span class="op">,</span> interpolated_jab<span class="op">);</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>RGBVec out <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>context<span class="op">.</span>C<span class="op">)</span> </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>draw contour lines<span class="op">}</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> out <span class="op">=</span> JzAzBz_to_RGB<span class="op">(</span>interpolated_jab<span class="op">);</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>output the color<span class="op">}</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>The default drawing mode simply draws the output of the interpolator (converted to RGB). An alternative drawing mode shows contour lines that aim to directly illustrate the topology of the weights used to interpolate between presets. This kind of visualization is akin to a terrain map where instead of illustrating elevation of the terrain, the contours illustrate the weight of a preset. For guidance in reading the contour map, consider the following:</p>
<ul>
<li>lines of the same color refer to the weight of the same preset</li>
<li>points on the sharp edge of a certain contour line all have the same weight</li>
<li>the change in weight from one line to the next is always the same, given by <code>1/C</code> where <code>C</code> is the number of lines requested by the command line argument (10 by default)</li>
<li>lines spaced close together represent a rapid change in weight</li>
<li>lines spaced far apart represent a gradual change</li>
<li>when a preset maxes out so that no other presets are involved in the output, a grid of dots is drawn on top of the contour peak</li>
<li>it’s usually best to focus on contour lines of one colour at a time</li>
</ul>
<p>Contour lines are drawn if the number of contour lines requested in the context structure is greater than zero. Additionally, if there is a demonstration selected (<code>context.grabbed</code> is not <code>nullptr</code>), contour lines are not drawn for other demonstrations; note that in such cases the for loop over demonstrations is broken after one pass, which itself doesn’t even refer to the iteration index.</p>
<p>The brightness calculation for contour lines is empirically set to look good and aid clear intuition; there is no special reason the lines are drawn in this particular way.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;globally visible state&#39;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> C <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;draw contour lines&#39;</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> n <span class="op">&lt;</span> context<span class="op">.</span>N<span class="op">;</span> <span class="op">++</span>n<span class="op">)</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    RGBVec rgb<span class="op">;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    Scalar w<span class="op">;</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>context<span class="op">.</span>grabbed<span class="op">)</span> </span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>        rgb <span class="op">=</span> JzAzBz_to_RGB<span class="op">(</span>context<span class="op">.</span>grabbed<span class="op">-&gt;</span>p<span class="op">);</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> meta<span class="op">[</span>context<span class="op">.</span>grabbed_idx<span class="op">].</span>w<span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        rgb <span class="op">=</span> JzAzBz_to_RGB<span class="op">(</span>context<span class="op">.</span>demo<span class="op">[</span>n<span class="op">].</span>p<span class="op">);</span> </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        w <span class="op">=</span> meta<span class="op">[</span>n<span class="op">].</span>w<span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>w <span class="op">&gt;=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>min<span class="op">()</span> <span class="op">*</span> <span class="dv">5</span><span class="op">)</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// visualize maximum elevation with inverted colour dots</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>        out <span class="op">=</span> <span class="op">(</span>xpix <span class="op">%</span> <span class="dv">3</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span>ypix <span class="op">%</span> <span class="dv">3</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> RGBVec<span class="op">{</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">}</span> <span class="op">-</span> rgb <span class="op">:</span> rgb<span class="op">;</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        Scalar brightness <span class="op">=</span> <span class="bu">std::</span>pow<span class="op">(</span><span class="bu">std::</span>fmod<span class="op">(</span>w <span class="op">*</span> context<span class="op">.</span>C<span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">),</span> <span class="dv">8</span><span class="op">);</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>        brightness <span class="op">=</span> brightness <span class="op">*</span> w<span class="op">;</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>        out <span class="op">+=</span> rgb <span class="op">*</span> brightness<span class="op">;</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>context<span class="op">.</span>grabbed<span class="op">)</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>The final colour is currently output using SDL’s render API, although the performance is not very good and this is likely to change.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;output the color&#39;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h3 id="event-handling">Event Handling</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;poll event queue and handle events&#39;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> SDL_Event ev<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span>SDL_PollEvent<span class="op">(&amp;</span>ev<span class="op">))</span> <span class="cf">switch</span> <span class="op">(</span>ev<span class="op">.</span>type<span class="op">)</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> SDL_QUIT<span class="op">:</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> SDL_APP_TERMINATING<span class="op">:</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> SDL_APP_LOWMEMORY<span class="op">:</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    context<span class="op">.</span>quit <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>handle window events<span class="op">}</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>handle keyboard events<span class="op">}</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>handle mouse events<span class="op">}</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="cf">default</span><span class="op">:</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;handle window events&#39;</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> SDL_WINDOWEVENT<span class="op">:</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// </span><span class="al">TODO</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;handle keyboard events&#39;</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> SDL_KEYDOWN<span class="op">:</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>C <span class="op">=</span> <span class="dv">10</span><span class="op">;</span> </span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>redraw <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> SDL_KEYUP<span class="op">:</span></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>C <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> </span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>redraw <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;handle mouse events&#39;</span></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> SDL_MOUSEMOTION<span class="op">:</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>mouse <span class="op">=</span> <span class="op">{</span>ev<span class="op">.</span>button<span class="op">.</span>x <span class="op">/</span> <span class="op">(</span>Scalar<span class="op">)</span>context<span class="op">.</span>w<span class="op">,</span> ev<span class="op">.</span>button<span class="op">.</span>y <span class="op">/</span> <span class="op">(</span>Scalar<span class="op">)</span>context<span class="op">.</span>h<span class="op">};</span></span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>context<span class="op">.</span>grabbed<span class="op">)</span></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>            context<span class="op">.</span>grabbed<span class="op">-&gt;</span>s <span class="op">=</span> context<span class="op">.</span>mouse<span class="op">;</span></span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a><span class="pp">#           ifndef __EMSCRIPTEN__</span></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>            context<span class="op">.</span>redraw <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a><span class="pp">#           endif</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> SDL_MOUSEBUTTONDOWN<span class="op">:</span></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>mouse <span class="op">=</span> <span class="op">{</span>ev<span class="op">.</span>button<span class="op">.</span>x <span class="op">/</span> <span class="op">(</span>Scalar<span class="op">)</span>context<span class="op">.</span>w<span class="op">,</span> ev<span class="op">.</span>button<span class="op">.</span>y <span class="op">/</span> <span class="op">(</span>Scalar<span class="op">)</span>context<span class="op">.</span>h<span class="op">};</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>            Scalar dist<span class="op">,</span> min_dist<span class="op">;</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>            min_dist <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>max<span class="op">();</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> n <span class="op">&lt;</span> context<span class="op">.</span>N<span class="op">;</span> <span class="op">++</span>n<span class="op">)</span></span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>                <span class="kw">auto</span><span class="op">&amp;</span> d <span class="op">=</span> context<span class="op">.</span>demo<span class="op">[</span>n<span class="op">];</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>                dist <span class="op">=</span> <span class="op">(</span>context<span class="op">.</span>mouse <span class="op">-</span> d<span class="op">.</span>s<span class="op">).</span>norm<span class="op">();</span></span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span>dist <span class="op">&lt;</span> min_dist<span class="op">)</span> </span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>                    context<span class="op">.</span>grabbed <span class="op">=</span> <span class="op">&amp;</span>d<span class="op">;</span></span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>                    context<span class="op">.</span>grabbed_idx <span class="op">=</span> n<span class="op">;</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>                    min_dist <span class="op">=</span> dist<span class="op">;</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>min_dist <span class="op">&gt;</span> context<span class="op">.</span>grab_dist <span class="op">/</span> <span class="op">(</span>Scalar<span class="op">)</span>context<span class="op">.</span>w<span class="op">)</span> context<span class="op">.</span>grabbed <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>context<span class="op">.</span>C<span class="op">)</span> context<span class="op">.</span>redraw <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> SDL_MOUSEBUTTONUP<span class="op">:</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>grabbed <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>redraw <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> SDL_MOUSEWHEEL<span class="op">:</span></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>active_interpolator <span class="op">=</span> <span class="op">(</span>context<span class="op">.</span>active_interpolator <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> context<span class="op">.</span>num_interpolators<span class="op">;</span></span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>        context<span class="op">.</span>redraw <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h3 id="setup">Setup</h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;setup&#39;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>SDL setup<span class="op">}</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>initialize random demonstrations<span class="op">}</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>resize interpolator extra lists<span class="op">}</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>create shader programs<span class="op">}</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>initialize vector buffer objects<span class="op">}</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>atexit<span class="op">(</span>cleanup<span class="op">);</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;globally visible state&#39;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>SDL_Window <span class="op">*</span> window <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>SDL_GLContext gl <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;SDL setup&#39;</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>SDL_Init<span class="op">(</span>SDL_INIT_VIDEO<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> </span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Error initializing SDL:</span><span class="sc">\n</span><span class="st">    </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>            SDL_GetError<span class="op">());</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> SDL_Log<span class="op">(</span><span class="st">&quot;Initialized successfully</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>SDL_GL_SetAttribute<span class="op">(</span>SDL_GL_CONTEXT_PROFILE_MASK<span class="op">,</span> SDL_GL_CONTEXT_PROFILE_ES<span class="op">);</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>SDL_GL_SetAttribute<span class="op">(</span>SDL_GL_CONTEXT_MAJOR_VERSION<span class="op">,</span> <span class="dv">3</span><span class="op">);</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>SDL_GL_SetAttribute<span class="op">(</span>SDL_GL_CONTEXT_MINOR_VERSION<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>SDL_GL_SetAttribute<span class="op">(</span>SDL_GL_DOUBLEBUFFER<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>context<span class="op">.</span>window <span class="op">=</span> SDL_CreateWindow</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">(</span> <span class="st">&quot;Interpolators&quot;</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> SDL_WINDOWPOS_CENTERED <span class="op">,</span> SDL_WINDOWPOS_CENTERED</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> context<span class="op">.</span>w <span class="op">,</span> context<span class="op">.</span>h</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> SDL_WINDOW_OPENGL <span class="op">|</span> SDL_WINDOW_ALLOW_HIGHDPI <span class="op">|</span> SDL_WINDOW_SHOWN</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>context<span class="op">.</span>window <span class="op">==</span> <span class="kw">nullptr</span><span class="op">)</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> </span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Error creating window:</span><span class="sc">\n</span><span class="st">    </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>            SDL_GetError<span class="op">());</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    SDL_ShowSimpleMessageBox<span class="op">(</span>SDL_MESSAGEBOX_ERROR<span class="op">,</span> <span class="st">&quot;Error&quot;</span><span class="op">,</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Couldn&#39;t create the main window :(&quot;</span><span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> SDL_Log<span class="op">(</span><span class="st">&quot;Created window</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>context<span class="op">.</span>gl <span class="op">=</span> SDL_GL_CreateContext<span class="op">(</span>context<span class="op">.</span>window<span class="op">);</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>context<span class="op">.</span>gl <span class="op">==</span> <span class="kw">nullptr</span><span class="op">)</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> </span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Error creating OpenGL context:</span><span class="sc">\n</span><span class="st">    </span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> </span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>            SDL_GetError<span class="op">());</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    SDL_ShowSimpleMessageBox<span class="op">(</span>SDL_MESSAGEBOX_ERROR<span class="op">,</span> <span class="st">&quot;Error&quot;</span><span class="op">,</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Couldn&#39;t create OpenGL context :(&quot;</span><span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span> SDL_Log<span class="op">(</span><span class="st">&quot;Created GL context</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;helper functions&#39;</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> cleanup <span class="op">()</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>    glDeleteProgram<span class="op">(</span>context<span class="op">.</span>prog<span class="op">);</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>    SDL_GL_DeleteContext<span class="op">(</span>context<span class="op">.</span>gl<span class="op">);</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>    SDL_DestroyWindow<span class="op">(</span>context<span class="op">.</span>window<span class="op">);</span></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>    SDL_Quit<span class="op">();</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;initialize random demonstrations&#39;</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> n <span class="op">=</span> context<span class="op">.</span>N<span class="op">;</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> seed <span class="op">=</span> <span class="bu">std::</span>chrono<span class="bu">::</span>system_clock<span class="bu">::</span>now<span class="op">().</span>time_since_epoch<span class="op">().</span>count<span class="op">();</span></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>default_random_engine<span class="op"> </span>generator <span class="op">(</span>seed<span class="op">);</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>uniform_real_distribution<span class="op">&lt;</span>Scalar<span class="op">&gt;</span> random<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span><span class="op">(</span>n<span class="op">--</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> v <span class="op">=</span> Vec2<span class="op">{</span>random<span class="op">(</span>generator<span class="op">),</span> random<span class="op">(</span>generator<span class="op">)};</span></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> c <span class="op">=</span> RGB_to_JzAzBz<span class="op">(</span>RGBVec<span class="op">{</span>random<span class="op">(</span>generator<span class="op">),</span> random<span class="op">(</span>generator<span class="op">),</span> random<span class="op">(</span>generator<span class="op">)});</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a>    context<span class="op">.</span>demo<span class="op">.</span>push_back<span class="op">({</span>n<span class="op">,</span> v<span class="op">,</span> c<span class="op">});</span></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;resize interpolators extra lists&#39;</span></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> resize_lists <span class="op">=</span> <span class="op">[&amp;](</span><span class="kw">auto</span><span class="op">&amp;</span> tup<span class="op">)</span></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span><span class="op">&amp;</span> meta <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span><span class="op">&amp;</span> para <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span><span class="op">&amp;</span> default_para <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">3</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>    meta<span class="op">.</span>resize<span class="op">(</span>context<span class="op">.</span>demo<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;</span> m <span class="op">:</span> meta<span class="op">)</span> m <span class="op">=</span> <span class="op">{};</span></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>    para<span class="op">.</span>resize<span class="op">(</span>context<span class="op">.</span>demo<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;</span> p <span class="op">:</span> para<span class="op">)</span> p <span class="op">=</span> default_para<span class="op">;</span></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>apply<span class="op">([&amp;](</span><span class="kw">auto</span><span class="op">&amp;</span> <span class="op">...</span> tuples<span class="op">)</span> <span class="op">{((</span>resize_lists<span class="op">(</span>tuples<span class="op">)),</span> <span class="op">...);},</span> interpolators<span class="op">);</span></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;helper functions&#39;</span></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Interpolator<span class="op">,</span> GLenum <span class="dt">shader_type</span><span class="op">&gt;</span></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>GLuint create_shader<span class="op">()</span></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>    GLuint shader<span class="op">;</span></span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> source<span class="op">;</span></span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> name<span class="op">;</span></span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span><span class="dt">shader_type</span> <span class="op">==</span> GL_VERTEX_SHADER<span class="op">)</span></span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>        shader <span class="op">=</span> glCreateShader<span class="op">(</span><span class="dt">shader_type</span><span class="op">);</span></span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a>        source <span class="op">=</span> Interpolator<span class="op">::</span>vert<span class="op">;</span></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> Interpolator<span class="op">::</span>vert_name<span class="op">;</span></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span> <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span><span class="dt">shader_type</span> <span class="op">==</span> GL_FRAGMENT_SHADER<span class="op">)</span></span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a>        shader <span class="op">=</span> glCreateShader<span class="op">(</span><span class="dt">shader_type</span><span class="op">);</span></span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a>        source <span class="op">=</span> Interpolator<span class="op">::</span>frag<span class="op">;</span></span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a>        name <span class="op">=</span> Interpolator<span class="op">::</span>frag_name<span class="op">;</span></span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a>    glShaderSource<span class="op">(</span>shader<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="op">(</span><span class="at">const</span> GLchar<span class="op">**)</span> <span class="op">&amp;</span>source<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a>    glCompileShader<span class="op">(</span>shader<span class="op">);</span></span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a>    GLint compiled <span class="op">=</span> GL_FALSE<span class="op">;</span></span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>    glGetShaderiv<span class="op">(</span>shader<span class="op">,</span> GL_COMPILE_STATUS<span class="op">,</span> <span class="op">&amp;</span>compiled<span class="op">);</span></span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">not</span> compiled<span class="op">)</span></span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a>        SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> <span class="st">&quot;Shader compilation failed: </span><span class="sc">%s</span><span class="st">.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> name<span class="op">);</span></span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a>        GLint logLength <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>        glGetShaderiv<span class="op">(</span>shader<span class="op">,</span> GL_INFO_LOG_LENGTH<span class="op">,</span> <span class="op">&amp;</span>logLength<span class="op">);</span></span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>        GLchar <span class="op">*</span> errLog <span class="op">=</span> <span class="op">(</span>GLchar<span class="op">*)</span>malloc<span class="op">(</span>logLength<span class="op">);</span></span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>errLog<span class="op">)</span></span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>            glGetShaderInfoLog<span class="op">(</span>shader<span class="op">,</span> logLength<span class="op">,</span> <span class="op">&amp;</span>logLength<span class="op">,</span> errLog<span class="op">);</span></span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>            SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> errLog<span class="op">);</span></span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a>            free<span class="op">(</span>errLog<span class="op">);</span></span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> <span class="st">&quot;Couldn&#39;t get shader log.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a>        glDeleteShader<span class="op">(</span>shader<span class="op">);</span></span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> shader<span class="op">;</span></span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Interpolator<span class="op">&gt;</span></span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a>GLuint create_program<span class="op">()</span></span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> vert <span class="op">=</span> Interpolator<span class="op">::</span>vert<span class="op">;</span></span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> vert_name <span class="op">=</span> Interpolator<span class="op">::</span>vert_name<span class="op">;</span></span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> frag <span class="op">=</span> Interpolator<span class="op">::</span>frag<span class="op">;</span></span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> frag_name <span class="op">=</span> Interpolator<span class="op">::</span>frag_name<span class="op">;</span></span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">char</span> <span class="op">*</span> prog_name <span class="op">=</span> Interpolator<span class="op">::</span>name<span class="op">;</span></span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a>    GLuint vertShader <span class="op">=</span> create_shader<span class="op">&lt;</span>Interpolator<span class="op">,</span> GL_VERTEX_SHADER<span class="op">&gt;();</span></span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>vertShader <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a>    GLuint fragShader <span class="op">=</span> create_shader<span class="op">&lt;</span>Interpolator<span class="op">,</span> GL_FRAGMENT_SHADER<span class="op">&gt;();</span></span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fragShader <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a>        glDeleteShader<span class="op">(</span>vertShader<span class="op">);</span></span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a>    GLuint program <span class="op">=</span> glCreateProgram<span class="op">();</span></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">not</span> program<span class="op">)</span></span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a>        SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> <span class="st">&quot;Couldn&#39;t create shader program: </span><span class="sc">%s</span><span class="st">.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> prog_name<span class="op">);</span></span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a>    glAttachShader<span class="op">(</span>program<span class="op">,</span> vertShader<span class="op">);</span></span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a>    glAttachShader<span class="op">(</span>program<span class="op">,</span> fragShader<span class="op">);</span></span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a>    glLinkProgram<span class="op">(</span>program<span class="op">);</span></span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a>    GLint linked <span class="op">=</span> GL_FALSE<span class="op">;</span></span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a>    glGetProgramiv<span class="op">(</span>program<span class="op">,</span> GL_LINK_STATUS<span class="op">,</span> <span class="op">&amp;</span>linked<span class="op">);</span></span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span><span class="kw">not</span> linked<span class="op">)</span></span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a>        SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> <span class="st">&quot;Shader linking failed: </span><span class="sc">%s</span><span class="st">.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> prog_name<span class="op">);</span></span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>        GLint logLength <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a>        glGetShaderiv<span class="op">(</span>program<span class="op">,</span> GL_INFO_LOG_LENGTH<span class="op">,</span> <span class="op">&amp;</span>logLength<span class="op">);</span></span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a>        GLchar <span class="op">*</span> errLog <span class="op">=</span> <span class="op">(</span>GLchar<span class="op">*)</span>malloc<span class="op">(</span>logLength<span class="op">);</span></span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>errLog<span class="op">)</span></span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a>            glGetProgramInfoLog<span class="op">(</span>program<span class="op">,</span> logLength<span class="op">,</span> <span class="op">&amp;</span>logLength<span class="op">,</span> errLog<span class="op">);</span></span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a>            SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> <span class="st">&quot;</span><span class="sc">%s\n</span><span class="st">&quot;</span><span class="op">,</span> errLog<span class="op">);</span></span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a>            free<span class="op">(</span>errLog<span class="op">);</span></span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> <span class="st">&quot;Couldn&#39;t get program log.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> errLog<span class="op">);</span></span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a>        glDeleteProgram<span class="op">(</span>program<span class="op">);</span></span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a>    glDeleteShader<span class="op">(</span>vertShader<span class="op">);</span></span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a>    glDeleteShader<span class="op">(</span>fragShader<span class="op">);</span></span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> program<span class="op">;</span></span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;globally visible state&#39;</span></span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a>GLuint prog <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-200"><a href="#cb17-200" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-201"><a href="#cb17-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-202"><a href="#cb17-202" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;create shader program&#39;</span></span>
<span id="cb17-203"><a href="#cb17-203" aria-hidden="true" tabindex="-1"></a>context<span class="op">.</span>prog <span class="op">=</span> create_program<span class="op">&lt;</span>Interpolator<span class="op">::</span>IntersectingNSpheres<span class="op">&gt;();</span></span>
<span id="cb17-204"><a href="#cb17-204" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span><span class="kw">not</span> context<span class="op">.</span>prog<span class="op">)</span> <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb17-205"><a href="#cb17-205" aria-hidden="true" tabindex="-1"></a>glUseProgram<span class="op">(</span>context<span class="op">.</span>prog<span class="op">);</span></span>
<span id="cb17-206"><a href="#cb17-206" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-207"><a href="#cb17-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-208"><a href="#cb17-208" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;helper functions&#39;</span></span>
<span id="cb17-209"><a href="#cb17-209" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> Vertex_s</span>
<span id="cb17-210"><a href="#cb17-210" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-211"><a href="#cb17-211" aria-hidden="true" tabindex="-1"></a>    <span class="dt">float</span> position<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb17-212"><a href="#cb17-212" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> Vertex<span class="op">;</span></span>
<span id="cb17-213"><a href="#cb17-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-214"><a href="#cb17-214" aria-hidden="true" tabindex="-1"></a>GLuint create_vbo<span class="op">(</span><span class="at">const</span> Vertex <span class="op">*</span>vertices<span class="op">,</span> GLuint numVertices<span class="op">)</span></span>
<span id="cb17-215"><a href="#cb17-215" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-216"><a href="#cb17-216" aria-hidden="true" tabindex="-1"></a>    GLuint vbo<span class="op">;</span></span>
<span id="cb17-217"><a href="#cb17-217" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> nBuffers <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-218"><a href="#cb17-218" aria-hidden="true" tabindex="-1"></a>    glGenBuffers<span class="op">(</span>nBuffers<span class="op">,</span> <span class="op">&amp;</span>vbo<span class="op">);</span></span>
<span id="cb17-219"><a href="#cb17-219" aria-hidden="true" tabindex="-1"></a>    glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> vbo<span class="op">);</span></span>
<span id="cb17-220"><a href="#cb17-220" aria-hidden="true" tabindex="-1"></a>    glBufferData<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Vertex<span class="op">)</span> <span class="op">*</span> numVertices<span class="op">,</span> vertices<span class="op">,</span> GL_STATIC_DRAW<span class="op">);</span></span>
<span id="cb17-221"><a href="#cb17-221" aria-hidden="true" tabindex="-1"></a>    glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-222"><a href="#cb17-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-223"><a href="#cb17-223" aria-hidden="true" tabindex="-1"></a>    GLenum err <span class="op">=</span> glGetError<span class="op">();</span></span>
<span id="cb17-224"><a href="#cb17-224" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>err <span class="op">!=</span> GL_NO_ERROR<span class="op">)</span></span>
<span id="cb17-225"><a href="#cb17-225" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb17-226"><a href="#cb17-226" aria-hidden="true" tabindex="-1"></a>        glDeleteBuffers<span class="op">(</span>nBuffers<span class="op">,</span> <span class="op">&amp;</span>vbo<span class="op">);</span></span>
<span id="cb17-227"><a href="#cb17-227" aria-hidden="true" tabindex="-1"></a>        SDL_LogError<span class="op">(</span>SDL_LOG_CATEGORY_APPLICATION<span class="op">,</span> <span class="st">&quot;VBO creation failed with code `</span><span class="sc">%u</span><span class="st">`.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> err<span class="op">);</span></span>
<span id="cb17-228"><a href="#cb17-228" aria-hidden="true" tabindex="-1"></a>        vbo <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-229"><a href="#cb17-229" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-230"><a href="#cb17-230" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-231"><a href="#cb17-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> vbo<span class="op">;</span></span>
<span id="cb17-232"><a href="#cb17-232" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-233"><a href="#cb17-233" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb17-234"><a href="#cb17-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-235"><a href="#cb17-235" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;create vector buffer objects&#39;</span></span>
<span id="cb17-236"><a href="#cb17-236" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> Vertex vertices<span class="op">[]</span> <span class="op">=</span> </span>
<span id="cb17-237"><a href="#cb17-237" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span> <span class="op">{</span><span class="fl">0.0</span><span class="bu">f</span><span class="op">,</span> <span class="op">-</span><span class="fl">0.9</span><span class="bu">f</span> <span class="op">}</span></span>
<span id="cb17-238"><a href="#cb17-238" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="op">{</span><span class="fl">0.9</span><span class="bu">f</span><span class="op">,</span> <span class="fl">0.9</span><span class="bu">f</span> <span class="op">}</span></span>
<span id="cb17-239"><a href="#cb17-239" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="op">{-</span><span class="fl">0.9</span><span class="bu">f</span><span class="op">,</span> <span class="fl">0.9</span><span class="bu">f</span> <span class="op">}</span></span>
<span id="cb17-240"><a href="#cb17-240" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb17-241"><a href="#cb17-241" aria-hidden="true" tabindex="-1"></a>GLsizei vertSize <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>vertices<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb17-242"><a href="#cb17-242" aria-hidden="true" tabindex="-1"></a>GLsizei numVertices <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>vertices<span class="op">)</span> <span class="op">/</span> vertSize<span class="op">;</span></span>
<span id="cb17-243"><a href="#cb17-243" aria-hidden="true" tabindex="-1"></a>GLuint triangleVBO <span class="op">=</span> create_vbo<span class="op">(</span>vertices<span class="op">,</span> numVertices<span class="op">);</span></span>
<span id="cb17-244"><a href="#cb17-244" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span><span class="kw">not</span> triangleVBO<span class="op">)</span> <span class="cf">return</span> EXIT_FAILURE<span class="op">;</span></span>
<span id="cb17-245"><a href="#cb17-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-246"><a href="#cb17-246" aria-hidden="true" tabindex="-1"></a>GLuint positionIdx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-247"><a href="#cb17-247" aria-hidden="true" tabindex="-1"></a>glBindBuffer<span class="op">(</span>GL_ARRAY_BUFFER<span class="op">,</span> triangleVBO<span class="op">);</span></span>
<span id="cb17-248"><a href="#cb17-248" aria-hidden="true" tabindex="-1"></a>glVertexAttribPointer<span class="op">(</span>positionIdx<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> GL_FLOAT<span class="op">,</span> FL_FALSE<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>Vertex<span class="op">),</span> <span class="op">(</span><span class="at">const</span> GLvoid<span class="op">*)</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-249"><a href="#cb17-249" aria-hidden="true" tabindex="-1"></a>glEnableVertexAttribArray<span class="op">(</span>positionIdx<span class="op">);</span></span>
<span id="cb17-250"><a href="#cb17-250" aria-hidden="true" tabindex="-1"></a>glDrawArray<span class="op">(</span>GL_TRIANGLES<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> numVertices<span class="op">);</span></span>
<span id="cb17-251"><a href="#cb17-251" aria-hidden="true" tabindex="-1"></a>SDL_GL_SwapWindow<span class="op">(</span>window<span class="op">);</span></span>
<span id="cb17-252"><a href="#cb17-252" aria-hidden="true" tabindex="-1"></a>glDeleteBuffer<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>vbo<span class="op">);</span></span>
<span id="cb17-253"><a href="#cb17-253" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h3 id="includes">Includes</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;includes&#39;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifdef __EMSCRIPTEN__</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;emscripten.h&gt;</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;tuple&gt;</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;chrono&gt;</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdio&gt;</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdlib&gt;</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;SDL.h&gt;</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;SDL_log.h&gt;</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;SDL_error.h&gt;</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;SDL_video.h&gt;</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;SDL_render.h&gt;</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;SDL_events.h&gt;</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;SDL_opengles2.h&gt;</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;GLES3/gl3.h&gt;</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Eigen/Core&gt;</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Eigen/LU&gt;</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;../interpolator/marier_spheres.h&quot;</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a><span class="co">//@+&#39;globally visible state&#39;</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span>Interpolator<span class="op">::</span>Demo<span class="op">&gt;</span> demo<span class="op">;</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t<span class="op"> </span>N <span class="op">=</span> <span class="dv">3</span><span class="op">;</span> <span class="co">// number of demonstrations</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="bu">std::</span>size_t<span class="op"> </span>num_interpolators <span class="op">=</span> <span class="bu">std::</span>tuple_size_v<span class="op">&lt;</span><span class="kw">decltype</span><span class="op">(</span>interpolators<span class="op">)&gt;;</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> w <span class="op">=</span> <span class="dv">500</span><span class="op">;</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">unsigned</span> <span class="dt">int</span> h <span class="op">=</span> <span class="dv">500</span><span class="op">;</span></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> redraw <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> quit <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    Scalar grab_dist <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    Interpolator<span class="op">::</span>Demo <span class="op">*</span> grabbed <span class="op">=</span> <span class="kw">nullptr</span><span class="op">;</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t<span class="op"> </span>grabbed_idx <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    Vec2 mouse <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h2 id="converting-rgb-to-perceptually-uniform-colour-space">Converting RGB to perceptually uniform colour space</h2>
<p>As mentioned above, the interpolator in the drawing example uses a perceptually uniform colour space called J_zA_zB_z to ensure that the topology of the interpolator is well represented by the image without distortion by the non-linear relationship of the colour representation to typical human colour vision. Since the colours are rendered in RGB, it is necessary to convert RGB to and from J_zA_zB_z It is assumed that the RGB colour values will be interpreted and displayed by the system as <a href="https://en.wikipedia.org/wiki/SRGB">sRGB</a>, a reasonable default assumption due to the ubiquitous use of this standard colour space on the web, OpenGL, and other standards and consumer optical equipment. Both sRGB and J_zA_zB_z colour spaces are defined relative to <a href="https://en.wikipedia.org/wiki/CIE_1931_color_space">CIE XYZ</a> colour space, a standard colour space defined by the International Commission on Illumination in 1931 that defines a quantitative representation of the physiological response of the eye as it relates to the perception of a certain colour. Given this shared root, converting to or from sRGB to J_zA_zB_z requires first converting to or from CIE XYZ. We assume that the sRGB values are normalized between 0.0 and 1.0, that the CIE XYZ Y value ranges between 0.0 and 1.0.</p>
<p>The conversion between sRGB and CIE XYZ is given in <a href="https://en.wikipedia.org/wiki/SRGB">the wikipedia page on sRGB</a>. Since the example programs make use of Eigen for their colour data, the conversion can be succinctly implemented with matrix multiplication and other Eigen features.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;RGB - XYZ colour conversions&#39;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>RGBVec XYZ_to_RGB<span class="op">(</span><span class="at">const</span> CIEXYZVec<span class="op">&amp;</span> xyz<span class="op">)</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    RGBVec rgb<span class="op">;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Matrix3f a<span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;&lt;</span>  <span class="fl">3.24096994</span><span class="op">,</span> <span class="op">-</span><span class="fl">1.53738318</span><span class="op">,</span> <span class="op">-</span><span class="fl">0.49861076</span><span class="op">,</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span><span class="fl">0.96924364</span><span class="op">,</span>  <span class="fl">1.8759675</span><span class="op">,</span>   <span class="fl">0.04155506</span><span class="op">,</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>          <span class="fl">0.05563008</span><span class="op">,</span> <span class="op">-</span><span class="fl">0.20397696</span><span class="op">,</span>  <span class="fl">1.05697151</span><span class="op">;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> a <span class="op">*</span> xyz<span class="op">;</span> <span class="co">// apply linear transformation</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> <span class="co">// apply gamme correction</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> u <span class="op">=</span> rgb<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> u <span class="op">&gt;</span> <span class="fl">0.0031308</span> <span class="op">?</span> <span class="op">(</span><span class="fl">1.055</span> <span class="op">*</span> pow<span class="op">(</span>u<span class="op">,</span> <span class="dv">1</span> <span class="op">/</span> <span class="fl">2.4</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.055</span><span class="op">)</span> <span class="op">:</span> <span class="fl">12.92</span> <span class="op">*</span> u<span class="op">;</span></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> u <span class="op">&lt;</span> <span class="fl">0.0</span> <span class="op">?</span> <span class="fl">0.0</span> <span class="op">:</span> u<span class="op">;</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> u <span class="op">&gt;</span> <span class="fl">1.0</span> <span class="op">?</span> <span class="fl">1.0</span> <span class="op">:</span> u<span class="op">;</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        rgb<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> u<span class="op">;</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rgb<span class="op">;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>CIEXYZVec RGB_to_XYZ<span class="op">(</span><span class="at">const</span> RGBVec<span class="op">&amp;</span> rgb<span class="op">)</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>    CIEXYZVec xyz <span class="op">=</span> rgb<span class="op">;</span></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Matrix3f a<span class="op">;</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;&lt;</span>  <span class="fl">0.41239080</span><span class="op">,</span>  <span class="fl">0.35758434</span><span class="op">,</span>  <span class="fl">0.18048079</span><span class="op">,</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>          <span class="fl">0.21263901</span><span class="op">,</span>  <span class="fl">0.71516868</span><span class="op">,</span>  <span class="fl">0.07219232</span><span class="op">,</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>          <span class="fl">0.01933082</span><span class="op">,</span>  <span class="fl">0.11919478</span><span class="op">,</span>  <span class="fl">0.95053215</span><span class="op">;</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> <span class="co">// reverse gamme correction</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> u <span class="op">=</span> xyz<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> u <span class="op">&gt;</span> <span class="fl">0.04045</span> <span class="op">?</span> pow<span class="op">((</span>u <span class="op">+</span> <span class="fl">0.055</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1.055</span><span class="op">,</span> <span class="fl">2.4</span><span class="op">)</span> <span class="op">:</span> u <span class="op">/</span> <span class="fl">12.92</span><span class="op">;</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>        xyz<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> u<span class="op">;</span></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">*</span> xyz<span class="op">;</span> <span class="co">// reverse linear transformation</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>The conversion between J_zA_zB_z and CIE XYZ is given in <a href="https://doi.org/10.1364/OE.25.015131">the 2017 paper by Safdar et al. introducing J_zA_zB_z published by the Optical Society of America in Volume 25 Issue 13 pages 15131-15151 of the journal Optics Express</a>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;JzAzBz consts&#39;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="at">const</span> Eigen<span class="op">::</span>Matrix3f M1 <span class="op">=</span> <span class="op">(</span>Eigen<span class="op">::</span>Matrix3f<span class="op">()</span> <span class="op">&lt;&lt;</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.41478972</span><span class="op">,</span>  <span class="fl">0.579999</span><span class="op">,</span>  <span class="fl">0.0146480</span><span class="op">,</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span><span class="fl">0.2015100</span><span class="op">,</span>  <span class="fl">1.120649</span><span class="op">,</span>  <span class="fl">0.0531008</span><span class="op">,</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span><span class="fl">0.0166008</span><span class="op">,</span>  <span class="fl">0.264800</span><span class="op">,</span>  <span class="fl">0.6684799</span><span class="op">).</span>finished<span class="op">();</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="at">const</span> Eigen<span class="op">::</span>Matrix3f M2 <span class="op">=</span> <span class="op">(</span>Eigen<span class="op">::</span>Matrix3f<span class="op">()</span> <span class="op">&lt;&lt;</span>  </span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.5</span><span class="op">,</span>         <span class="fl">0.5</span><span class="op">,</span>       <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="fl">3.524000</span><span class="op">,</span>   <span class="op">-</span><span class="fl">4.066708</span><span class="op">,</span>  <span class="fl">0.542708</span><span class="op">,</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.199076</span><span class="op">,</span>    <span class="fl">1.096799</span><span class="op">,</span> <span class="op">-</span><span class="fl">1.295875</span><span class="op">).</span>finished<span class="op">();</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> two5 <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> two7 <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">7</span><span class="op">;</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> two12 <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">12</span><span class="op">;</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> two14 <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">14</span><span class="op">;</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> b <span class="op">=</span> <span class="fl">1.15</span><span class="op">;</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> g <span class="op">=</span> <span class="fl">0.66</span><span class="op">;</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> c1 <span class="op">=</span> <span class="fl">3424.0</span> <span class="op">/</span> two12<span class="op">;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> c2 <span class="op">=</span> <span class="fl">2413.0</span> <span class="op">/</span> two7<span class="op">;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> c3 <span class="op">=</span> <span class="fl">2392.0</span> <span class="op">/</span> two7<span class="op">;</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> n <span class="op">=</span> <span class="fl">2610.0</span> <span class="op">/</span> two14<span class="op">;</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> p <span class="op">=</span> <span class="fl">1.7</span> <span class="op">*</span> <span class="fl">2523.0</span> <span class="op">/</span> two5<span class="op">;</span></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> d <span class="op">=</span> <span class="op">-</span><span class="fl">0.56</span><span class="op">;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> d_0 <span class="op">=</span> <span class="fl">1.6295499532821566e-11</span><span class="op">;</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;JzAzBz - XYZ colour conversions&#39;</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>JzAzBzVec XYZ_to_JzAzBz<span class="op">(</span><span class="at">const</span> CIEXYZVec<span class="op">&amp;</span> xyz<span class="op">)</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>JzAzBz consts<span class="op">}</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> x <span class="op">=</span> xyz<span class="op">.</span>x<span class="op">();</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> y <span class="op">=</span> xyz<span class="op">.</span>y<span class="op">();</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> z <span class="op">=</span> xyz<span class="op">.</span>z<span class="op">();</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// pre-adjust to improve iso-hue linearity (Safdar et al. eqn. 8</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">x_</span> <span class="op">=</span> b <span class="op">*</span> x <span class="op">-</span> <span class="op">(</span>b <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> z<span class="op">;</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">y_</span> <span class="op">=</span> g <span class="op">*</span> y <span class="op">-</span> <span class="op">(</span>g <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>    CIEXYZVec <span class="va">xyz_</span><span class="op">(</span><span class="va">x_</span><span class="op">,</span> <span class="va">y_</span><span class="op">,</span> z<span class="op">);</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// transform xyz to cone primaries (Safdar et al. eqn. 9)</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Vector3f lms <span class="op">=</span> M1 <span class="op">*</span> <span class="va">xyz_</span><span class="op">;</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// perceptual quantizer (Safdar et al. eqn. 10</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> u <span class="op">=</span> pow<span class="op">(</span>lms<span class="op">[</span>i<span class="op">]</span> <span class="op">/</span> <span class="fl">10000.0</span><span class="op">,</span> n<span class="op">);</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>        lms<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> pow<span class="op">(</span> <span class="op">(</span>c1 <span class="op">+</span> c2 <span class="op">*</span> u<span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> c3 <span class="op">*</span> u<span class="op">),</span> p <span class="op">);</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// transform to correlates of opponent colour space (Safdar et al. eqn. 11)</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Vector3f jab <span class="op">=</span> M2 <span class="op">*</span> lms<span class="op">;</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// improve wide-range lightness prediction (Safdar et al. eqn. 12)</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> i <span class="op">=</span> jab<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    jab<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">((</span><span class="fl">1.0</span> <span class="op">+</span> d<span class="op">)</span> <span class="op">*</span> i<span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> d <span class="op">*</span> i<span class="op">)</span> <span class="op">-</span> d_0<span class="op">;</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jab<span class="op">;</span></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>CIEXYZVec JzAzBz_to_XYZ<span class="op">(</span><span class="at">const</span> JzAzBzVec<span class="op">&amp;</span> jab<span class="op">)</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>JzAzBz consts<span class="op">}</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="at">const</span> Eigen<span class="op">::</span>Matrix3f M1inv <span class="op">=</span> M1<span class="op">.</span>inverse<span class="op">();</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="at">const</span> Eigen<span class="op">::</span>Matrix3f M2inv <span class="op">=</span> M2<span class="op">.</span>inverse<span class="op">();</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 17</span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> iab <span class="op">=</span> jab<span class="op">;</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> j <span class="op">=</span> jab<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> d_0<span class="op">;</span></span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    iab<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> j <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> d <span class="op">-</span> d <span class="op">*</span> j<span class="op">);</span></span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 18</span></span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Vector3f lms <span class="op">=</span> M2inv <span class="op">*</span> iab<span class="op">;</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 19</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> u <span class="op">=</span> pow<span class="op">(</span>lms<span class="op">[</span>i<span class="op">],</span> <span class="fl">1.0</span><span class="op">/</span>p<span class="op">);</span></span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>        lms<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">10000.0</span> <span class="op">*</span> pow<span class="op">(</span> <span class="op">(</span>c1 <span class="op">-</span> u<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>c3 <span class="op">*</span> u <span class="op">-</span> c2<span class="op">),</span> <span class="fl">1.0</span><span class="op">/</span>n <span class="op">);</span></span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 20</span></span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">xyz_</span> <span class="op">=</span> M1inv <span class="op">*</span> lms<span class="op">;</span></span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 21 - 23</span></span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">x_</span> <span class="op">=</span> <span class="va">xyz_</span><span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">y_</span> <span class="op">=</span> <span class="va">xyz_</span><span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">z_</span> <span class="op">=</span> <span class="va">xyz_</span><span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> x <span class="op">=</span> <span class="op">(</span><span class="va">x_</span> <span class="op">+</span> <span class="op">(</span>b <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> <span class="va">z_</span><span class="op">)</span> <span class="op">/</span> b<span class="op">;</span></span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> y <span class="op">=</span> <span class="op">(</span><span class="va">y_</span> <span class="op">+</span> <span class="op">(</span>g <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> x<span class="op">)</span> <span class="op">/</span> g<span class="op">;</span></span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> z <span class="op">=</span> <span class="va">z_</span><span class="op">;</span></span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>    CIEXYZVec xyz<span class="op">{</span>x<span class="op">,</span> y<span class="op">,</span> z<span class="op">};</span></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> xyz<span class="op">;</span></span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>The conversion between sRGB and J_zA_zB_z is then easily implemented in terms of the above conversions to and from CIE XYZ colour space:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;colour conversions&#39;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>RGB <span class="op">-</span> XYZ colour conversions<span class="op">}</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>JzAzBz <span class="op">-</span> XYZ colour conversions<span class="op">}</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>JzAzBzVec RGB_to_JzAzBz<span class="op">(</span><span class="at">const</span> RGBVec<span class="op">&amp;</span> rgb<span class="op">)</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> XYZ_to_JzAzBz<span class="op">(</span>RGB_to_XYZ<span class="op">(</span>rgb<span class="op">));</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>RGBVec JzAzBz_to_RGB<span class="op">(</span><span class="at">const</span> JzAzBzVec<span class="op">&amp;</span> jab<span class="op">)</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> XYZ_to_RGB<span class="op">(</span>JzAzBz_to_XYZ<span class="op">(</span>jab<span class="op">));</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h2 id="compiling-examples">Compiling Examples</h2>
<p>A simple Makefile is included in this repository with rules for building the demo app, as well as for generating the machine source code and pretty-printed source code from this literate source code document using <a href="https://github.com/DocSunset/lilit"><code>lilit</code></a>. The Makefile is tested and working on the author’s Arch Linux system. As usual, I am open to recommendations and pull requests to improve the compatibility of the Makefile, or on other ways of building for various platforms.</p>
</body>
</html>
