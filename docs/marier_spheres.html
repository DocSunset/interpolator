<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Marier Intersecting N-Spheres Interpolator</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <link rel="stylesheet" type="text/css" href="http://traviswest.ca/style.css">
</head>
<body>
<header id="title-block-header">
<h1 class="title">Marier Intersecting N-Spheres Interpolator</h1>
</header>
<h1 id="introduction">Introduction</h1>
<p>In sound design, digital musical instrument design, and intermedia art in general, creators often deal with complex generative systems with numerous control parameters: sound and video synthesizers and processors, simulations, and artificially intelligent agents are a few examples. These systems are often capable of producing a combinatorially immense variety of interesting behaviors (sounds, images, etc.) based on the state of their parameters. Much of the creative work of using and interacting with these systems comes down to exploring these vast spaces of possibilities, perhaps noting points of interest along the way. Eventually, entire compositions, installations, or musical instruments can be devised by selecting the paths to navigate within these spaces of possibilities.</p>
<p>A useful tool in the exploration and navigation of these spaces is preset interpolation. After manually recording points of interest in parameter space as presets, preset interpolation algorithms are used to automatically move between these predetermined a-priori interesting places, filling in the space between them with intermediate locations that are likely, by proximity, to also be interesting. This allows the user of a preset interpolation algorithm to move easily through the space of possibilities demarcated by the points of interest they record as presets, facilitating the discovery of other interesting points in space and of interesting paths through space.</p>
<p>What is especially useful about preset interpolation is that it allows the user to reframe the navigation of the control parameter space in terms of another separate space of control sources. For instance, the presets in parameter space can be associated with locations on a two dimensional map, often significantly reducing the dimensionality of navigation with an associated reduction in the difficulty of navigation. Alternatively, the control sources from a complex gestural interface can be used instead of a two dimensional map, allowing the destination space to be navigated by moving through the space of gestures afforded by the interface. These kinds of mappings are often essential in the design of digital musical instruments, and can be equally rewarding in other intermedia artistic practices.</p>
<h1 id="theory">Theory</h1>
<p>The basic operating principle of many preset interpolation algorithms, including the one presented here, is for the user to specify pairs of source-to-destination associations in the form of presets in these two spaces. As a concrete example, the user might be exploring the space of sounds produced by a synthesizer with possibly a very large number of parameters. They might explore for a while by manually configuring the synthesizer, and note several particularly interesting preset sound configurations. Then, to facilitate live performance with the synthesizer, the user may wish to control it with a graphics tablet. They can associate several locations on the tablet with different presets found earlier, and then use the preset interpolation algorithm to navigate between these presets. The tablet locations can also be thought of as presets, but located in the source space (the tablet’s control dimensions) rather than the destination space (the sound synthesizer parameters).</p>
<p>To remain unambiguous, for the rest of this exposition preset points in source space will be refered to as source vectors while preset points in destination space will be referred to as destination vectors. The word vector reflects the assumption inherent in most preset interpolation algorithms that the source and destination spaces are both vector spaces, meaning that presets can be meaningfully scaled and added together, and that there is a meaningful notion of distance between presets. A pair made of a source vector <span class="math inline">\(s\)</span> and a destination vector <span class="math inline">\(p\)</span> to which the sources in the vicinity of <span class="math inline">\(s\)</span> should be associated will be called a demonstration, <span class="math inline">\(d = \{s, p\}\)</span>. This reflects an interaction metaphor in which the user is thought to provide demonstrations of action-to-output relationships, i.e. “when I do <span class="math inline">\(s\)</span>, the interpolator should output <span class="math inline">\(p\)</span>.” The symbol <span class="math inline">\(p\)</span> is chosen for destination vectors based on the common situtation in which the destination space consists of the control parameters of some media generator such as a sound synthesizer, and to avoid collision with <span class="math inline">\(d\)</span> for a demonstration of a source-to-destination pair.</p>
<p>The basic principle of many interpolation algorithms is to interpolate between <span class="math inline">\(N\)</span> destination vectors <span class="math inline">\(p_n\)</span> producing an output vector <span class="math inline">\(y\)</span> in destination space via a weighted sum with weights given by <span class="math inline">\(\boldsymbol{w}\)</span>:</p>
<p><span class="math display">\[
y(\boldsymbol{w}) = \sum_{n = 0}^{N - 1} w_n * p_n
\]</span></p>
<p>The role of the preset interpolator is then reduced to simply producing and applying a list of weights, usually as a function of a query or cursor vector <span class="math inline">\(q\)</span> in the source space, and list <span class="math inline">\(D\)</span> of <span class="math inline">\(N\)</span> demonstrations.</p>
<p><span class="math display">\[
\boldsymbol{w}(q, D) = {w_0, w_1, w_2, ..., w_{n}} 
\]</span> <span class="math display">\[
D = \{s_0, p_0\}, \{s_1, p_1\}, \{s_2, p_2\}, ..., \{s_n, p_n\}
\]</span></p>
<h1 id="intersecting-n-spheres-interpolation">Intersecting N-Spheres Interpolation</h1>
<h2 id="description">Description</h2>
<p>Martin Marier introduced the <em>intersecting n-spheres interpolation</em> algorithm as part of his work with The Sponge, a deformable digital musical instrument which Marier has been developing for over a decade. This algorithm produces an interpolated output that is smooth (i.e. continuously differentiable), continuous, maps from any number of source dimensions to any number of destination dimensions, exactly passes through the demonstrated destination points, and locally depends only on nearby demonstrations. The algorithm also imposes no constraints on the placement of source and destination presets, unlike other algorithms which might require points to be evenly distributed or quantized to a grid. Furthermore, the algorithm allows for the position of presets to be dynamically varied in real-time, allowing the possibility for higher-level mappings such as navigating destination presets for the preset interpolation system itself using a higher-level preset interpolator.</p>
<p>Intersecting n-spheres interpolation produces weights for a weighted sum according to the following procedure. In summary, for each demonstration two circles are drawn: one centered on the source vector of the demonstration, and one centered on the query vector (again in source space). The radius of either circle is given by the distance from the circle’s center point (either the query vector or the source vector in a demonstration) to its nearest neighbour in source space (which may again be either the query point or a source vector in a demonstration). The weight for each demonstration is given by the ratio of the area of the circle centered on the demonstration’s source vector, and the area of the intersection of that circle with the circle centered on the query point. In a practical implementation, the procedure in full proceeds as follows.</p>
<p>Given a query point <span class="math inline">\(q\)</span>, and a list of demonstrations consisting of <span class="math inline">\(N\)</span> points in source space <span class="math inline">\(s_n\)</span> paired with the same number of points in destination space <span class="math inline">\(p_n\)</span>:</p>
<ol type="1">
<li><p>Determine the distance <span class="math inline">\(d_n\)</span> from each demonstrated source point <span class="math inline">\(s_n\)</span> to the cursor point <span class="math inline">\(q\)</span>. At the same time, search for the nearest neighbour of <span class="math inline">\(q\)</span> and record its distance from <span class="math inline">\(q\)</span> as <span class="math inline">\(r_q\)</span>.</p></li>
<li><p>For every point demonstrated point in source space <span class="math inline">\(s_n\)</span>, calculate and record the distance <span class="math inline">\(r_n\)</span> from that point to its nearest neighbour in source space (not including <span class="math inline">\(q\)</span>).</p></li>
<li><p>The weight <span class="math inline">\(w_n\)</span> associated with the destination vector <span class="math inline">\(p_n\)</span> of the <span class="math inline">\(n\)</span>th demonstration is given by <span class="math inline">\(A_x(r_q, min(r_n, r_q), d_n) / A(r_n)\)</span> where <span class="math inline">\(A\)</span> is the area of the circle centered on <span class="math inline">\(s_n\)</span> with radius <span class="math inline">\(r_n\)</span>, and where <span class="math inline">\(A_x\)</span> is the area of the intersection of two circles:</p></li>
</ol>
<ul>
<li>The circle centered on <span class="math inline">\(s_n\)</span> with radius given by the minimum between <span class="math inline">\(r_n\)</span> or <span class="math inline">\(r_q\)</span>,</li>
<li>and the circle centered on <span class="math inline">\(q\)</span> with radius <span class="math inline">\(r_q\)</span>,</li>
<li>with the circles defined to lay on the same plane, which may be any plane passing through both <span class="math inline">\(s_n\)</span> and <span class="math inline">\(q\)</span>.</li>
</ul>
<p>Note that <span class="math inline">\(A_x\)</span> depends only on the radii of the two circles <span class="math inline">\(r_q\)</span> and <span class="math inline">\(r_n\)</span>, and the distance <span class="math inline">\(d_n\)</span> between them.</p>
<ol start="4" type="1">
<li><p>Calculate the interpolated output <span class="math inline">\(p\)</span> in destination space as the weighted sum of demonstrated outputs <span class="math inline">\(p_n\)</span>.</p></li>
<li><p>Normalize the weights (or equivalently the weighted sum) so that their sum is equal to one by dividing each weight <span class="math inline">\(w_n\)</span> by the mean of all the weights <span class="math inline">\(\mu = \frac{1}{N}\sum_{n = 0}^{N - 1} w_n\)</span></p></li>
</ol>
<p><span class="math inline">\(A_x\)</span> is given by the following function:</p>
<p><span class="math display">\[
\begin{aligned}
A_x(R, r, d) &amp;= r^2 cos^(-1) ( \frac{d^2 + r^2 - R^2}{2dr} ) \\
             &amp;+ R^2 cos^(-1) ( \frac{d^2 + R^2 - r^2}{2dR} ) \\
             &amp;- \frac{\sqrt{(-d + r + R)(d + r - R)(d - r + R)(d + r + R)}}{2}
\end{aligned}
\]</span></p>
<p>And <span class="math inline">\(A\)</span> is given by the usual equation for the area of a circle: <span class="math display">\[
A(r) = \pi r^2
\]</span></p>
<p>The algorithm, despite its name, actually doesn’t involve any n-spheres. Intead, 2D circles are used, simplifying the algorithm while producing results that “are predictable and feel natural to the user” according to Marier.</p>
<h2 id="implementation">Implementation</h2>
<p>The weighted sum in Marier’s algorithm implies that the destination space is some kind of vector space, while the requirement for a notion of distance implies that the source space is a normed vector space, most often an Euclidean vector space. These assumptions are represented in the implementation by the assumption that the templated <code>PVector</code> for the destination space will have an operator for multiplication by a scalar, and addition of two vectors, and that the templated <code>SVector</code> for the source space will have the same two operators as well as a method <code>norm</code> that returns the length of a vector.</p>
<p>The functions to compute the weight for a single destination vector are generally straightforward to implement based on the equations above.</p>
<p>One necessary quirk: when the interpolator is used with <code>float</code> scalars, the argument to the <code>acos</code> and <code>sqrt</code> calls sometimes fall just outside the domain of the functions. Boundary conditions are checked if <code>Scalar</code> is <code>float</code>: in testing, the <code>acos</code> args only ever fell at or slightly above <code>1.0f</code>, so this is the only condition which is addressed by the boundary check for these args.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;weight functions&#39;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>Scalar circle_circle_intersection_area<span class="op">(</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> Scalar<span class="op">&amp;</span> R<span class="op">,</span> </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> Scalar<span class="op">&amp;</span> r<span class="op">,</span> </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> Scalar<span class="op">&amp;</span> d<span class="op">)</span> <span class="at">const</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    Scalar d2 <span class="op">=</span> d <span class="op">*</span> d<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    Scalar r2 <span class="op">=</span> r <span class="op">*</span> r<span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    Scalar R2 <span class="op">=</span> R <span class="op">*</span> R<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    Scalar two_d <span class="op">=</span> <span class="op">(</span>Scalar<span class="op">)</span><span class="dv">2</span> <span class="op">*</span> d<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    Scalar arg1 <span class="op">=</span> <span class="op">(</span>d2 <span class="op">+</span> r2 <span class="op">-</span> R2<span class="op">)/(</span>two_d <span class="op">*</span> r<span class="op">);</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    Scalar arg2 <span class="op">=</span> <span class="op">(</span>d2 <span class="op">+</span> R2 <span class="op">-</span> r2<span class="op">)/(</span>two_d <span class="op">*</span> R<span class="op">);</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    Scalar arg3 <span class="op">=</span> <span class="op">(-</span>d<span class="op">+</span>r<span class="op">+</span> R<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>d<span class="op">+</span>r<span class="op">-</span>R<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>d<span class="op">-</span>r<span class="op">+</span>R<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>d<span class="op">+</span>r<span class="op">+</span>R<span class="op">);</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    Scalar a<span class="op">,</span> b<span class="op">,</span> c<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span><span class="bu">std::</span>is_same_v<span class="op">&lt;</span>Scalar<span class="op">,</span> <span class="dt">float</span><span class="op">&gt;)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>arg1 <span class="op">&gt;</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span> a <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> a <span class="op">=</span> r2 <span class="op">*</span> <span class="bu">std::</span>acos<span class="op">(</span>arg1<span class="op">);</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>arg2 <span class="op">&gt;</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span> b <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> b <span class="op">=</span> R2 <span class="op">*</span> <span class="bu">std::</span>acos<span class="op">(</span>arg2<span class="op">);</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>arg3 <span class="op">&lt;</span> <span class="fl">0.0</span><span class="bu">f</span><span class="op">)</span> c <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span> c <span class="op">=</span> <span class="bu">std::</span>sqrt<span class="op">(</span>arg3<span class="op">)</span> <span class="op">/</span> <span class="fl">2.0</span><span class="bu">f</span><span class="op">;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        a <span class="op">=</span> r2 <span class="op">*</span> <span class="bu">std::</span>acos<span class="op">(</span>arg1<span class="op">);</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        b <span class="op">=</span> R2 <span class="op">*</span> <span class="bu">std::</span>acos<span class="op">(</span>arg2<span class="op">);</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        c <span class="op">=</span> <span class="bu">std::</span>sqrt<span class="op">(</span>arg3<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>Scalar<span class="op">)</span><span class="fl">2.0</span><span class="op">;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">+</span> b <span class="op">-</span> c<span class="op">;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>Scalar circle_area<span class="op">(</span><span class="at">const</span> Scalar<span class="op">&amp;</span> r<span class="op">)</span> <span class="at">const</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> Scalar pi <span class="op">=</span> <span class="fl">3.14159265358979323846264338327950288419716939937510582097494459230781640628620899863</span><span class="op">;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pi <span class="op">*</span> r <span class="op">*</span> r<span class="op">;</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>Scalar intersecting_spheres_weight<span class="op">(</span><span class="at">const</span> Scalar<span class="op">&amp;</span> R<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> r<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> d<span class="op">)</span> <span class="at">const</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> circle_circle_intersection_area<span class="op">(</span>R<span class="op">,</span> r<span class="op">,</span> d<span class="op">)</span> <span class="op">/</span> circle_area<span class="op">(</span>r<span class="op">);</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>Step 2 above is an instance of the “all nearest neighbours” problem. We are given a set of points (the demonstrated points in the source space plus the cursor point) and for each point <span class="math inline">\(p\)</span> we need to determine the nearest other point in the space <span class="math inline">\(p_{\text{nearest}}\)</span>, which will be used to determine the radius of the circle associated with <span class="math inline">\(p\)</span>.</p>
<p>Based on a cursory and incomplete review of the literature, efficient algorithms appear to exist which solve the all nearest neighbours problem in <span class="math inline">\(O(n\log n)\)</span> time, or even in <span class="math inline">\(O(n)\)</span> time if certain constraints are met. Unfortunately, comprehending (let alone implementing) the linear time algorithms for this problem is non-trivial, so we opt to use a simpler algorithm until such time as it becomes clear that optimization is necessary.</p>
<p>If we assume that the demonstrations may change at any time, then updating any of the points in source space including the cursor point always requires the nearest neighbour problem to be solved anew, because the nearest neighbour of the updated point and any point that it was previously the nearest neighbour of it all have to be updated. Because the position of the cursor point is assumed to change whenever the interpolator is queried, this means that the nearest neighbour problem must be solved for every query. The trivial implementation used here (as well as in Marier’s original Supercollider implementation of the algorithm) solves this problem with <span class="math inline">\(O(n^2)\)</span> time complexity using plain old brute force; the distance from every point to every other point is calculated, and the nearest neighbour is found as the point with the least calculated distance value. In Marier’s practice this <span class="math inline">\(O(n^2)\)</span> time complexity hasn’t been reported as an issue, presumably because the number of data points has always been reasonably low.</p>
<p>However, if we assume that the demonstrations have not changed since the last query, then it should be unnecessary to solve the all nearest neighbours problem. Instead, the weights can be generated in linear time, since only the distance from the query point to each demonstration needs to be calculated.</p>
<p>In either case, the query function is logically pure. The result depends only on the demonstration and query points. The output consists of the weighted sum, but also the weights, distances, and radii calculated along the way. These latter values are useful for interactive applications such as the OpenGL demo presented later, since they allow the inner workings of the algorithm to be rendered to the user.</p>
<p>The interpolation function is implemented as a class for a few reasons. This allows the metadata and parameter structures unique to this interpolator to be accessible through the type system whenever you have an instance of this interpolator. The Intersecting N-Spheres algorithm doesn’t have any parameters, but other algorithms will require these, so a <code>Para</code> structure is declared to provide a consistent interface. The class is also used as the interface to set interpolator-specific global parameters, such as the flag <code>dynamic_demos</code> that is used to decide whether to skip the nearest-neighbours problem. Finally, the class is used to store interpolator-specific global outputs, such as the <code>r_q</code> radius calculated in the N-Spheres algorithm.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;interpolators&#39;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> IntersectingNSpheres</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Meta <span class="op">{</span> Scalar r <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> d <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> w <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Para <span class="op">{</span> <span class="co">/* none */</span> <span class="op">};</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> dynamic_demos <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mutable</span> Scalar r_q<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>weight functions<span class="op">}</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> DemoList<span class="op">,</span> <span class="kw">typename</span> MetaList<span class="op">,</span> <span class="kw">typename</span> ParaList<span class="op">&gt;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    PVector query<span class="op">(</span><span class="at">const</span> SVector<span class="op">&amp;</span> q<span class="op">,</span> <span class="at">const</span> DemoList<span class="op">&amp;</span> demo<span class="op">,</span> <span class="at">const</span> ParaList<span class="op">&amp;</span> para<span class="op">,</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>            MetaList<span class="op">&amp;</span> meta<span class="op">,</span> PVector<span class="op">&amp;</span> weighted_sum<span class="op">)</span> <span class="at">const</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        Scalar sum_of_weights <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>demo<span class="op">.</span>size<span class="op">()</span> <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>demo<span class="op">.</span>size<span class="op">()</span> <span class="op">!=</span> meta<span class="op">.</span>size<span class="op">())</span> <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// step 1</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>calculate radius r_q <span class="kw">and</span> distances d_n<span class="op">}</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">std::</span>size_t<span class="op"> </span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> demo<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">const</span> SVector<span class="op">&amp;</span> <span class="va">s_n</span> <span class="op">=</span> demo<span class="op">[</span>i<span class="op">].</span>s<span class="op">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">const</span> PVector<span class="op">&amp;</span> p_n <span class="op">=</span> demo<span class="op">[</span>i<span class="op">].</span>p<span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>            Scalar<span class="op">&amp;</span> r_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>r<span class="op">;</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>            Scalar<span class="op">&amp;</span> d_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>d<span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>            Scalar<span class="op">&amp;</span> w_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>w<span class="op">;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>dynamic_demos<span class="op">)</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>                <span class="co">// step 2</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>                <span class="er">@</span><span class="op">{</span>calculate the radius r_n<span class="op">}</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">((</span>r_q <span class="op">+</span> r_n<span class="op">)</span> <span class="op">&lt;</span> d_n<span class="op">)</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>                w_n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span> <span class="co">// the circles are non-intersecting</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>            <span class="co">// step 3</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>            w_n <span class="op">=</span> intersecting_spheres_weight<span class="op">(</span>r_q<span class="op">,</span> r_n <span class="op">&lt;</span> d_n <span class="op">?</span> r_n <span class="op">:</span> d_n<span class="op">,</span> d_n<span class="op">);</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a>            <span class="co">// step 4</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>            weighted_sum <span class="op">=</span> weighted_sum <span class="op">+</span> w_n <span class="op">*</span> p_n<span class="op">;</span></span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>            sum_of_weights <span class="op">=</span> sum_of_weights <span class="op">+</span> w_n<span class="op">;</span></span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// step 5</span></span>
<span id="cb2-52"><a href="#cb2-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Meta<span class="op">&amp;</span> m <span class="op">:</span> meta<span class="op">)</span> <span class="op">{</span> m<span class="op">.</span>w <span class="op">=</span> m<span class="op">.</span>w <span class="op">/</span> sum_of_weights<span class="op">;</span> <span class="op">}</span></span>
<span id="cb2-53"><a href="#cb2-53" aria-hidden="true" tabindex="-1"></a>        weighted_sum <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">/</span> sum_of_weights<span class="op">)</span> <span class="op">*</span> weighted_sum<span class="op">;</span></span>
<span id="cb2-54"><a href="#cb2-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-55"><a href="#cb2-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb2-56"><a href="#cb2-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-57"><a href="#cb2-57" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb2-58"><a href="#cb2-58" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>One quirk of the above implementation is that the output (<code>weighted_sum</code>) is passed by variable. This is necessary to avoid having to initialize <code>weighted_sum</code> to zero. By leaving this responsibility to the caller, the implementation of the interpolator is more generic, only imposing the need for operators for addition and multiplication by a scalar, and <code>size()</code> member and index operator for the lists. In other words, the interpolator doesn’t know how to initialize a <code>PVector</code>, which could be a raw float array, a complicated linear algebra library vector, or anything else, as long as it has addition and multiplication by a scalar. Since <code>PVector</code> is so generic, the implementation of the interpolator can’t make assumptions about how to construct or initialize it.</p>
<h3 id="implementation-details">Implementation details</h3>
<p>Although every demonstration will be visited in the main loop of the query function, the radius of the query point has to be known in advance in order to calculate the weight associated with each demonstration. While searching for the query point’s nearest neighbour, it is convenient to also cache the distance from the query point to every demonstration.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;calculate radius r_q and distances d_n&#39;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>r_q <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>max<span class="op">();</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">std::</span>size_t<span class="op"> </span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> demo<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> SVector<span class="op">&amp;</span> <span class="va">s_n</span> <span class="op">=</span> demo<span class="op">[</span>i<span class="op">].</span>s<span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> PVector<span class="op">&amp;</span> p_n <span class="op">=</span> demo<span class="op">[</span>i<span class="op">].</span>p<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    Scalar<span class="op">&amp;</span> d_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>d<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    Scalar<span class="op">&amp;</span> w_n <span class="op">=</span> meta<span class="op">[</span>i<span class="op">].</span>w<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    d_n <span class="op">=</span> <span class="op">(</span><span class="va">s_n</span> <span class="op">-</span> q<span class="op">).</span>norm<span class="op">();</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>d_n <span class="op">&lt;</span> r_q<span class="op">)</span> r_q <span class="op">=</span> d_n<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>avoid numerical imprecision issues<span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>As the query point approaches the position of a demonstrated point, the size of both <span class="math inline">\(A_x\)</span> and <span class="math inline">\(A\)</span> get smaller and smaller, which would likely lead to numerical instability when calculating the weight <span class="math inline">\(A_x/A\)</span>. For this reason, an arbitrary amount of sloppiness is introduced into the determination of whether the query point exactly coincides with a demonstrated point, so that the ratio <span class="math inline">\(A_x/A\)</span> will not be calculated if the query is too close to a demonstration. Instead, if the query is close enough to the demonstration then the exact value of the demonstration is returned and further calculation of the weighted sum is short-circuited. This condition is checked while calculating the distance from the current source vector to the query point, which takes place just before searching for the radius of the circle centered on the source vector. Although this also short circuits the recalculation of all the metadata calculated during a query, it is presumed that this condition will be approached gradually and encountered rarely and briefly, and that the metadata will therefore be close enough for practical purposes.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;avoid numerical imprecision issues&#39;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> Scalar an_arbitrary_slop_factor <span class="op">=</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>epsilon<span class="op">()</span> <span class="op">*</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>d_n <span class="op">&lt;=</span> an_arbitrary_slop_factor<span class="op">)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    w_n <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    weighted_sum <span class="op">=</span> p_n<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>Finding the radius of the circle centered on the demonstration <code>demo</code> is done by brute force search, as mentioned above. The distance from <code>demo</code> to ever other demonstration is checked, and the least distance is recorded. Finally, the distance from the demonstration to the query point is checked, and this is used if it is less than the distance from the demonstration to the nearest other demonstration.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;calculate the radius r_n&#39;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>r_n <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>max<span class="op">();</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="at">const</span> Demo<span class="op">&amp;</span> demo2 <span class="op">:</span> demo<span class="op">)</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>demo<span class="op">[</span>i<span class="op">].</span>id <span class="op">==</span> demo2<span class="op">.</span>id<span class="op">)</span> <span class="cf">continue</span><span class="op">;</span> <span class="co">// demo cannot be its own nearest neighbour</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    Scalar r <span class="op">=</span> <span class="op">(</span><span class="va">s_n</span> <span class="op">-</span> demo2<span class="op">.</span>s<span class="op">).</span>norm<span class="op">();</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>r <span class="op">&lt;</span> r_n<span class="op">)</span> r_n <span class="op">=</span> r<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h2 id="inverse-distance-interpolator">Inverse Distance Interpolator</h2>
<p>Another simple interpolation algorithm is presented here. This algorithm is one of the earliest proposed in the literature, with roots in the early 1980s with the SYTER system developed at GRM. The implementation below follows the presentation by Todoroff and colleagues in their 2009 paper at the International Computer Music Conference, “1-d, 2-d and 3-d interpolation tools for max/msp/jitter.” Despite the name of their paper, the algorithm naturally extends to arbitrary source and destination spatial dimensions.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @+&#39;interpolators&#39;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> InverseDistance <span class="co">/* after e.g. Todoroff 2009 ICMC */</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Meta <span class="op">{</span> Scalar d <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> w <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">};</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Para </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span> </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        Scalar power <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span>      d_min <span class="op">=</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>min<span class="op">()</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span>      r_min <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span>      r <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> DemoList<span class="op">,</span> <span class="kw">typename</span> MetaList<span class="op">,</span> <span class="kw">typename</span> ParaList<span class="op">&gt;</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    PVector query<span class="op">(</span><span class="at">const</span> SVector<span class="op">&amp;</span> q<span class="op">,</span> <span class="at">const</span> DemoList<span class="op">&amp;</span> demo<span class="op">,</span> <span class="at">const</span> ParaList<span class="op">&amp;</span> para<span class="op">,</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>            MetaList<span class="op">&amp;</span> meta<span class="op">,</span> PVector<span class="op">&amp;</span> weighted_sum<span class="op">)</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        Scalar sum_of_weights <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>size_t<span class="op"> </span>i<span class="op">,</span> N <span class="op">=</span> demo<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>N <span class="op">&lt;</span> <span class="dv">1</span><span class="op">)</span> <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>N <span class="op">!=</span> meta<span class="op">.</span>size<span class="op">())</span> <span class="cf">return</span> weighted_sum<span class="op">;</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>N<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span>  <span class="op">{</span> meta<span class="op">[</span>i<span class="op">].</span>d <span class="op">=</span> <span class="op">(</span>demo<span class="op">[</span>i<span class="op">].</span>s <span class="op">-</span> q<span class="op">).</span>norm<span class="op">();</span> <span class="op">}</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>N<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span>  </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span> </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">auto</span> base <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>meta<span class="op">[</span>i<span class="op">].</span>d <span class="op">-</span> para<span class="op">[</span>i<span class="op">].</span>r_min<span class="op">,</span> para<span class="op">[</span>i<span class="op">].</span>d_min<span class="op">);</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            meta<span class="op">[</span>i<span class="op">].</span>w <span class="op">=</span> para<span class="op">[</span>i<span class="op">].</span>r <span class="op">/</span> pow<span class="op">(</span> base<span class="op">,</span> para<span class="op">[</span>i<span class="op">].</span>power<span class="op">);</span> </span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>i<span class="op">=</span><span class="dv">0</span><span class="op">;</span> i<span class="op">&lt;</span>N<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span>  <span class="op">{</span> weighted_sum <span class="op">=</span> weighted_sum <span class="op">+</span> meta<span class="op">[</span>i<span class="op">].</span>w <span class="op">*</span> demo<span class="op">[</span>i<span class="op">].</span>p<span class="op">;</span> <span class="op">}</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Meta<span class="op">&amp;</span> m <span class="op">:</span> meta<span class="op">)</span> <span class="op">{</span> sum_of_weights <span class="op">=</span> sum_of_weights <span class="op">+</span> m<span class="op">.</span>w<span class="op">;</span> <span class="op">}</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span>Meta<span class="op">&amp;</span> m <span class="op">:</span> meta<span class="op">)</span> <span class="op">{</span> m<span class="op">.</span>w <span class="op">=</span> m<span class="op">.</span>w <span class="op">/</span> sum_of_weights<span class="op">;</span> <span class="op">}</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> weighted_sum <span class="op">=</span> <span class="op">(</span><span class="dv">1</span> <span class="op">/</span> sum_of_weights<span class="op">)</span> <span class="op">*</span> weighted_sum<span class="op">;</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h2 id="summary">Summary</h2>
<p>The interpolators are all gathered inside of a shared <code>struct</code>. This is done in order to propagate the template parameters for the <code>Scalar, ID, SVector,</code> and <code>PVector</code> types to all the interpolators so that in case the calling program wants to use the same types for all interpolators they only need to declare them once. The demonstration type, <code>struct Demo</code>, is also declared at this level.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @#&#39;interpolator/marier_spheres.h&#39;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#ifndef MARIER_SPHERES_INTERPOLATOR_H</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define MARIER_SPHERES_INTERPOLATOR_H</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;limits&gt;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include</span><span class="im">&lt;cstddef&gt;</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span><span class="op">&lt;</span><span class="kw">typename</span> Scalar<span class="op">,</span> <span class="kw">typename</span> ID<span class="op">,</span> <span class="kw">typename</span> SVector<span class="op">,</span> <span class="kw">typename</span> PVector<span class="op">&gt;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> Interpolators</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> Demo <span class="op">{</span> ID id<span class="op">;</span> SVector s<span class="op">;</span> PVector p<span class="op">;</span> <span class="op">};</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>interpolators<span class="op">}</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#endif</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h1 id="usage">Usage</h1>
<p>The remainder of this document elaborates some example programs demonstrating the usage of the library. The drawing example renders an image based on interpolating randomly generated colors associated with randomly generated 2D positions. The interactive example works similarly, only instead of systematically querying the image the user moves a cursor around it to query the interpolated colors, and the graphics are updated in real time to reflect the underlying state of the interpolator.</p>
<h2 id="drawing-example">Drawing example</h2>
<p>This simple command line drawing application will randomly generate a handful of source-destination demonstrations, and draw an image by systematically querying the source space. As well as producing an image that might offer some intuition about the topology of the interpolated output, this will also serve as a reasonable benchmark for the efficiency of the implementation if the number of pixels in the image is large enough. The initial implementation of the interpolator, when compiled with optimizations enabled, could process about 15000 queries per second with 5 demonstrations, about 5000 per second with 15 demonstrations, 2200 with 25 demonstrations, and 1200 with 35 demonstrations. As per the quadratic time complexity of this implementation, the number of queries processed per second decreases by a multiplicative factor as the number of demonstrations increases linearly. Performance on larger datasets is improved significantly, as expected, if the quadratic-time all nearest neighbours problem is avoided by assuming that demonstrations are unchanged between interpolations. This optimization can be enabled by passing the -f flag to this example program when running it.</p>
<p>The colour interpolations are performed in <a href="https://doi.org/10.1364/OE.25.015131">J_zA_zB_z colour space</a>, a colour representation that is designed to provide the best balance of perceptual uniformity and iso-hue linearity. This is meant to ensure that the image produced reflects the topology of the interpolation rather than the non-linearity of sRGB colour space. The details of the conversion from RGB (assumed sRGB) through CIE XYZ to J_zA_zB_z colour space and back are given below.</p>
<p>The program is relatively simple, so here’s an overview.</p>
<p>First, the datatypes used are declared, along with a tuple of interpolators with their default parameters and containers to hold their metadata and parameter lists:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;basic globals&#39;</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> Scalar <span class="op">=</span> <span class="dt">float</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> ID <span class="op">=</span> <span class="dt">unsigned</span> <span class="dt">int</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> Vec2 <span class="op">=</span> Eigen<span class="op">::</span>Vector2f<span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> RGBVec <span class="op">=</span> Eigen<span class="op">::</span>Vector3f<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> CIEXYZVec <span class="op">=</span> Eigen<span class="op">::</span>Vector3f<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> JzAzBzVec <span class="op">=</span> Eigen<span class="op">::</span>Vector3f<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> Interp <span class="op">=</span> Interpolators<span class="op">&lt;</span>Scalar<span class="op">,</span> ID<span class="op">,</span> Vec2<span class="op">,</span> JzAzBzVec<span class="op">&gt;;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;drawing interpolators&#39;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ANOTHER_INTERPOLATOR</span><span class="op">(</span>type<span class="op">,</span><span class="pp"> </span><span class="op">...)</span><span class="pp"> </span><span class="bu">std::</span>make_tuple<span class="op">(</span>type<span class="op">{},</span><span class="pp"> </span><span class="bu">std::</span>vector<span class="op">&lt;</span>type<span class="op">::</span>Meta<span class="op">&gt;{},</span><span class="pp"> </span><span class="bu">std::</span>vector<span class="op">&lt;</span>type<span class="op">::</span>Para<span class="op">&gt;{},</span><span class="pp"> </span>type<span class="op">::</span>Para<span class="op">{</span><span class="ot">__VA_ARGS__</span><span class="op">},</span><span class="pp"> </span>bitmap_image<span class="op">{},</span><span class="pp"> </span>bitmap_image<span class="op">{})</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> interpolators <span class="op">=</span> <span class="bu">std::</span>make_tuple</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="op"> </span>       <span class="op">(</span> ANOTHER_INTERPOLATOR<span class="op">(</span>Interp<span class="op">::</span>IntersectingNSpheres<span class="op">)</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> ANOTHER_INTERPOLATOR<span class="op">(</span>Interp<span class="op">::</span>InverseDistance<span class="op">,</span> <span class="dv">4</span><span class="op">,</span> <span class="fl">0.001</span><span class="op">,</span> <span class="fl">0.0</span><span class="op">)</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>Then the program itself is as follows. Notice that most of the program logic is contained in a generic lambda function that is applied to the tuple of interpolators. Each time the function is invoked, it is given a new tuple containing an interpolator and the data associated with it.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @#&#39;examples/color_image.cpp&#39;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdio&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;chrono&gt;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;tuple&gt;</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;include/fire-hpp/fire.hpp&quot;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;include/bitmap/bitmap_image.hpp&quot;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;../interpolator/marier_spheres.h&quot;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Eigen/Core&gt;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Eigen/LU&gt;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>basic globals<span class="op">}</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>drawing interpolators<span class="op">}</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>colour conversions<span class="op">}</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fired_main</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span> <span class="dt">unsigned</span> <span class="dt">int</span> x <span class="op">=</span> fire<span class="op">::</span>arg<span class="op">(</span><span class="st">&quot;x&quot;</span><span class="op">,</span> <span class="st">&quot;The horizontal dimension in pixels&quot;</span><span class="op">,</span> <span class="dv">500</span><span class="op">)</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> y <span class="op">=</span> fire<span class="op">::</span>arg<span class="op">(</span><span class="st">&quot;y&quot;</span><span class="op">,</span> <span class="st">&quot;The vertical dimension in pixels&quot;</span><span class="op">,</span> <span class="dv">500</span><span class="op">)</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">,</span> <span class="dt">bool</span> fast <span class="op">=</span> fire<span class="op">::</span>arg<span class="op">(</span><span class="st">&quot;f&quot;</span><span class="op">,</span> <span class="st">&quot;Set whether to calculate as though demonstrations are dynamic or not. Defaults to slow dynamic mode.&quot;</span><span class="op">)</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> N <span class="op">=</span> fire<span class="op">::</span>arg<span class="op">(</span><span class="st">&quot;n&quot;</span><span class="op">,</span> <span class="st">&quot;The number of demonstrations&quot;</span><span class="op">,</span> <span class="dv">5</span><span class="op">)</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">,</span> <span class="dt">unsigned</span> <span class="dt">int</span> C <span class="op">=</span> fire<span class="op">::</span>arg<span class="op">(</span><span class="st">&quot;c&quot;</span><span class="op">,</span> <span class="st">&quot;The number of contour lines for each preset in the contour map. Set to zero to disable the contour map&quot;</span><span class="op">,</span> <span class="dv">10</span><span class="op">)</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> dynamic_demos <span class="op">=</span> <span class="kw">not</span> fast<span class="op">;</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>vector<span class="op">&lt;</span>Interp<span class="op">::</span>Demo<span class="op">&gt;</span> demo<span class="op">;</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>generate random demonstrations<span class="op">}</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> interpolate_and_draw <span class="op">=</span> <span class="op">[&amp;](</span><span class="kw">auto</span><span class="op">&amp;</span> tup<span class="op">)</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// unpack the tuple</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span><span class="op">&amp;</span> interpolator <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span><span class="op">&amp;</span> meta <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span><span class="op">&amp;</span> para <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span><span class="op">&amp;</span> default_para <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">3</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span><span class="op">&amp;</span> colours_map <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">4</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span><span class="op">&amp;</span> contour_map <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">5</span><span class="op">&gt;(</span>tup<span class="op">);</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// resize the interpolator&#39;s lists to match the number of demonstrations</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>        meta<span class="op">.</span>resize<span class="op">(</span>demo<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;</span> m <span class="op">:</span> meta<span class="op">)</span> m <span class="op">=</span> <span class="op">{};</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>        para<span class="op">.</span>resize<span class="op">(</span>demo<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;</span> p <span class="op">:</span> para<span class="op">)</span> p <span class="op">=</span> default_para<span class="op">;</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// clear the bitmap images</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        colours_map <span class="op">=</span> bitmap_image<span class="op">{</span>x<span class="op">,</span> y<span class="op">};</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>        colours_map<span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>C<span class="op">)</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>            contour_map <span class="op">=</span> bitmap_image<span class="op">{</span>x<span class="op">,</span> y<span class="op">};</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>            contour_map<span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>draw the images<span class="op">}</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>draw circles over demonstrated points<span class="op">}</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">// save the images</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>        colours_map<span class="op">.</span>save_image<span class="op">(</span><span class="bu">std::</span>string<span class="op">(</span><span class="st">&quot;interpolated_colors&quot;</span><span class="op">)</span> <span class="op">+</span> <span class="bu">std::</span>to_string<span class="op">(</span>i<span class="op">)</span> <span class="op">+</span> <span class="bu">std::</span>string<span class="op">(</span><span class="st">&quot;.bmp&quot;</span><span class="op">));</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>C<span class="op">)</span> contour_map<span class="op">.</span>save_image<span class="op">(</span><span class="bu">std::</span>string<span class="op">(</span><span class="st">&quot;interpolated_colors_weight_contours&quot;</span><span class="op">)</span> <span class="op">+</span> <span class="bu">std::</span>to_string<span class="op">(</span>i<span class="op">)</span> <span class="op">+</span> <span class="bu">std::</span>string<span class="op">(</span><span class="st">&quot;.bmp&quot;</span><span class="op">));</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">++</span>i<span class="op">;</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>apply<span class="op">([&amp;](</span><span class="kw">auto</span><span class="op">&amp;</span> <span class="op">...</span> tup<span class="op">)</span> <span class="op">{</span> <span class="op">((</span> interpolate_and_draw<span class="op">(</span>tup<span class="op">)</span> <span class="op">),</span> <span class="op">...</span> <span class="op">);</span> <span class="op">},</span> interpolators<span class="op">);</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>FIRE<span class="op">(</span>fired_main<span class="op">)</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>We assume that the source dimensions range from 0 to 1 and that the colour channels in an RGB colour vector do the same. Randomly generating vectors is then trivial. The RGB colour vector is then converted to J_zA_zB_z colour space. It is more convenient to generate the colour vectors in RGB space since doing so guarantees that the demonstrated colors are possible to display, which may not be the case when randomly generating colors in J_zA_zB_z space.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;generate random demonstrations&#39;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> n <span class="op">=</span> N<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> seed <span class="op">=</span> <span class="bu">std::</span>chrono<span class="bu">::</span>system_clock<span class="bu">::</span>now<span class="op">().</span>time_since_epoch<span class="op">().</span>count<span class="op">();</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>default_random_engine<span class="op"> </span>generator <span class="op">(</span>seed<span class="op">);</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>uniform_real_distribution<span class="op">&lt;</span>Scalar<span class="op">&gt;</span> random<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span><span class="op">(</span>n<span class="op">--</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> v <span class="op">=</span> Vec2<span class="op">{</span>random<span class="op">(</span>generator<span class="op">),</span> random<span class="op">(</span>generator<span class="op">)};</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> c <span class="op">=</span> RGB_to_JzAzBz<span class="op">(</span>RGBVec<span class="op">{</span>random<span class="op">(</span>generator<span class="op">),</span> random<span class="op">(</span>generator<span class="op">),</span> random<span class="op">(</span>generator<span class="op">)});</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    demo<span class="op">.</span>push_back<span class="op">({</span>n<span class="op">,</span> v<span class="op">,</span> c<span class="op">});</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>Drawing the basic interpolated-colours image is quite simple; simply iterate over the dimensions of the image and query the interpolator at each coordinate, convert the resulting colour to RGB, and then write the colour to the pixel at that coordinate. We record how long this takes so that the program also serves as a simple benchmark.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;draw the images&#39;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bool</span> ran <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> start <span class="op">=</span> <span class="bu">std::</span>chrono<span class="bu">::</span>high_resolution_clock<span class="bu">::</span>now<span class="op">();</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> xpix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> xpix <span class="op">&lt;</span> x<span class="op">;</span> <span class="op">++</span>xpix<span class="op">)</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> ypix <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> ypix <span class="op">&lt;</span> y<span class="op">;</span> <span class="op">++</span>ypix<span class="op">)</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">auto</span> q <span class="op">=</span> Vec2<span class="op">{</span>xpix<span class="op">/(</span>Scalar<span class="op">)</span>x<span class="op">,</span> ypix<span class="op">/(</span>Scalar<span class="op">)</span>y<span class="op">};</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            JzAzBzVec interpolated_jab<span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">constexpr</span> <span class="op">(</span><span class="bu">std::</span>is_same_v<span class="op">&lt;</span><span class="kw">decltype</span><span class="op">(</span>interpolator<span class="op">),</span> Interp<span class="op">::</span>IntersectingNSpheres<span class="op">&gt;)</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>            <span class="op">{</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">(</span><span class="kw">not</span> dynamic_demos <span class="op">&amp;&amp;</span> <span class="kw">not</span> ran<span class="op">)</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                <span class="op">{</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                    interpolator<span class="op">.</span>dynamic_demos <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                    interpolator<span class="op">.</span>query<span class="op">(</span>q<span class="op">,</span> demo<span class="op">,</span> para<span class="op">,</span> meta<span class="op">,</span> interpolated_jab<span class="op">);</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>                    interpolator<span class="op">.</span>dynamic_demos <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>                    ran <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span> interpolator<span class="op">.</span>query<span class="op">(</span>q<span class="op">,</span> demo<span class="op">,</span> para<span class="op">,</span> meta<span class="op">,</span> interpolated_jab<span class="op">);</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span> interpolator<span class="op">.</span>query<span class="op">(</span>q<span class="op">,</span> demo<span class="op">,</span> para<span class="op">,</span> meta<span class="op">,</span> interpolated_jab<span class="op">);</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>            RGBVec out <span class="op">=</span> JzAzBz_to_RGB<span class="op">(</span>interpolated_jab<span class="op">);</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>            colours_map<span class="op">.</span>set_pixel<span class="op">(</span>xpix<span class="op">,</span> ypix<span class="op">,</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                    <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">)</span><span class="bu">std::</span>round<span class="op">(</span>out<span class="op">.</span>x<span class="op">()</span> <span class="op">*</span> <span class="dv">255</span><span class="op">),</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                    <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">)</span><span class="bu">std::</span>round<span class="op">(</span>out<span class="op">.</span>y<span class="op">()</span> <span class="op">*</span> <span class="dv">255</span><span class="op">),</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                    <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">)</span><span class="bu">std::</span>round<span class="op">(</span>out<span class="op">.</span>z<span class="op">()</span> <span class="op">*</span> <span class="dv">255</span><span class="op">));</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>            <span class="er">@</span><span class="op">{</span>draw the contour image<span class="op">}</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> stop <span class="op">=</span> <span class="bu">std::</span>chrono<span class="bu">::</span>high_resolution_clock<span class="bu">::</span>now<span class="op">();</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> usec <span class="op">=</span> <span class="bu">std::</span>chrono<span class="bu">::</span>duration_cast<span class="op">&lt;</span><span class="bu">std::</span>chrono<span class="bu">::</span>microseconds<span class="op">&gt;(</span>stop <span class="op">-</span> start<span class="op">).</span>count<span class="op">();</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cout<span class="op"> &lt;&lt;</span> i <span class="op">&lt;&lt;</span> <span class="st">&quot;: Generated &quot;</span> <span class="op">&lt;&lt;</span> x <span class="op">*</span> y <span class="op">&lt;&lt;</span> <span class="st">&quot; interpolations in &quot;</span> <span class="op">&lt;&lt;</span> usec <span class="op">&lt;&lt;</span> <span class="st">&quot; microseconds</span><span class="sc">\n</span><span class="st">&quot;</span> </span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;&lt;</span> <span class="st">&quot;About &quot;</span> <span class="op">&lt;&lt;</span> <span class="dv">1000000</span> <span class="op">*</span> x <span class="op">*</span> y <span class="op">/</span> usec <span class="op">&lt;&lt;</span> <span class="st">&quot; interpolations per second&quot;</span> </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>Additionally, a contour map is drawn which aims to directly illustrate the topology of the weights used to interpolate between presets. This kind of visualization is akin to a terrain map where instead of illustrating elevation of the terrain, the contours illustrate the weight of a preset. For guidance in reading the contour map, consider the following:</p>
<ul>
<li>lines of the same color refer to the weight of the same preset</li>
<li>points on the sharp edge of a certain contour line all have the same weight</li>
<li>the change in weight from one line to the next is always the same, given by <code>1/C</code> where <code>C</code> is the number of lines requested by the command line argument (10 by default)</li>
<li>lines spaced close together represent a rapid change in weight</li>
<li>lines spaced far apart represent a gradual change</li>
<li>when a preset maxes out so that no other presets are involved in the output, a grid of dots is drawn on top of the contour peak</li>
<li>it’s usually best to focus on contour lines of one colour at a time</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;draw the contour image&#39;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>C<span class="op">)</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> n <span class="op">&lt;</span> demo<span class="op">.</span>size<span class="op">();</span> <span class="op">++</span>n<span class="op">)</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> rgb <span class="op">=</span> JzAzBz_to_RGB<span class="op">(</span>demo<span class="op">[</span>n<span class="op">].</span>p<span class="op">);</span> </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>meta<span class="op">[</span>n<span class="op">].</span>w <span class="op">&gt;=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="bu">std::</span>numeric_limits<span class="op">&lt;</span>Scalar<span class="op">&gt;::</span>min<span class="op">()</span> <span class="op">*</span> <span class="dv">5</span><span class="op">)</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>            <span class="co">// visualize maximum elevation with inverted colour dots</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>            out <span class="op">=</span> <span class="op">(</span>xpix <span class="op">%</span> <span class="dv">3</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span>ypix <span class="op">%</span> <span class="dv">3</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">?</span> RGBVec<span class="op">{</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">}</span> <span class="op">-</span> rgb <span class="op">:</span> rgb<span class="op">;</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">{</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>            Scalar brightness <span class="op">=</span> <span class="bu">std::</span>pow<span class="op">(</span><span class="bu">std::</span>fmod<span class="op">(</span>meta<span class="op">[</span>n<span class="op">].</span>w <span class="op">*</span> C<span class="op">,</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">),</span> <span class="dv">8</span><span class="op">);</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>            out <span class="op">+=</span> rgb <span class="op">*</span> brightness<span class="op">;</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    contour_map<span class="op">.</span>set_pixel<span class="op">(</span>xpix<span class="op">,</span> ypix<span class="op">,</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">)</span><span class="bu">std::</span>round<span class="op">(</span><span class="bu">std::</span>min<span class="op">(</span>out<span class="op">.</span>x<span class="op">(),</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span> <span class="op">*</span> <span class="dv">255</span><span class="op">),</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">)</span><span class="bu">std::</span>round<span class="op">(</span><span class="bu">std::</span>min<span class="op">(</span>out<span class="op">.</span>y<span class="op">(),</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span> <span class="op">*</span> <span class="dv">255</span><span class="op">),</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">char</span><span class="op">)</span><span class="bu">std::</span>round<span class="op">(</span><span class="bu">std::</span>min<span class="op">(</span>out<span class="op">.</span>z<span class="op">(),</span> <span class="fl">1.0</span><span class="bu">f</span><span class="op">)</span> <span class="op">*</span> <span class="dv">255</span><span class="op">));</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>After drawing the overall image<span class="op">,</span> we also take a moment to draw a circle around</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>each demonstration point<span class="op">;</span> <span class="kw">this</span> helps to better understand how the image relates</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>to the topology of the interpolator<span class="op">.</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a><span class="er">```</span>c<span class="op">++</span> </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;draw circles over demonstrated points&#39;</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> draw_circles <span class="op">=</span> <span class="op">[&amp;](</span><span class="kw">auto</span><span class="op">&amp;</span> img<span class="op">)</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    image_drawer draw<span class="op">(</span>img<span class="op">);</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    draw<span class="op">.</span>pen_width<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> d <span class="op">:</span> demo<span class="op">)</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> Vec2<span class="op">&amp;</span> v <span class="op">=</span> d<span class="op">.</span>s<span class="op">;</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> RGBVec<span class="op">&amp;</span> c <span class="op">=</span> JzAzBz_to_RGB<span class="op">(</span>d<span class="op">.</span>p<span class="op">);</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        draw<span class="op">.</span>pen_color<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        draw<span class="op">.</span>pen_width<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        draw<span class="op">.</span>circle<span class="op">(</span>v<span class="op">.</span>x<span class="op">()</span> <span class="op">*</span> x<span class="op">,</span> v<span class="op">.</span>y<span class="op">()</span> <span class="op">*</span> y<span class="op">,</span> <span class="dv">7</span><span class="op">);</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>        draw<span class="op">.</span>pen_color<span class="op">(</span><span class="dv">255</span><span class="op">,</span><span class="dv">255</span><span class="op">,</span><span class="dv">255</span><span class="op">);</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        draw<span class="op">.</span>circle<span class="op">(</span>v<span class="op">.</span>x<span class="op">()</span> <span class="op">*</span> x<span class="op">,</span> v<span class="op">.</span>y<span class="op">()</span> <span class="op">*</span> y<span class="op">,</span> <span class="dv">5</span><span class="op">);</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        draw<span class="op">.</span>pen_color<span class="op">(</span>c<span class="op">.</span>x<span class="op">()</span> <span class="op">*</span> <span class="dv">255</span><span class="op">,</span> c<span class="op">.</span>y<span class="op">()</span> <span class="op">*</span> <span class="dv">255</span><span class="op">,</span> c<span class="op">.</span>z<span class="op">()</span> <span class="op">*</span> <span class="dv">255</span><span class="op">);</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>        draw<span class="op">.</span>pen_width<span class="op">(</span><span class="dv">3</span><span class="op">);</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>        draw<span class="op">.</span>circle<span class="op">(</span>v<span class="op">.</span>x<span class="op">()</span> <span class="op">*</span> x<span class="op">,</span> v<span class="op">.</span>y<span class="op">()</span> <span class="op">*</span> y<span class="op">,</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>draw_circles<span class="op">(</span>colours_map<span class="op">);</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>draw_circles<span class="op">(</span>contour_map<span class="op">);</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h2 id="opengl-interactive-example">OpenGL Interactive Example</h2>
<p>This example offers some insight into the inner workings of the interpolator. A handful of demonstrations associating random 2D positions with random colors are generated. The position and colour of each point is visualized by drawing a dot of the appropriate colour at that position. In addition, a circle is drawn around each dot with the radius associated to that demonstration by the interpolator; notice how each demonstrated point’s radial circle always intersects at least one other dot, which is the nearest neighbour of that demonstrated point. Finally, a grey region is drawn beneath each dot whose size and brightness reflect the contribution of that dot to the weighted sum.</p>
<p>The position of the query point is based on the position of the cursor within the screen. Its colour is based on the result of the interpolation. A radial circle is also drawn for this point.</p>
<p>The bulk of this happens in the display callback. For some reason, it appears to be necessary to draw in depth order (back to front) so that the dots and radial lines dont become obscured by the weight disk in the back. If anyone can explain why this is, please contact me. The z-coordinate doesn’t appear to have any influence, even with depth testing enabled.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;display callback&#39;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> drawCircle<span class="op">(</span><span class="at">const</span> Vec2<span class="op">&amp;</span> position<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> radius<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> depth <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> Scalar pi <span class="op">=</span> <span class="fl">3.14159265358979323846264338327950288419716939937510582097494459230781640628620899863</span><span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">float</span> w <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> w <span class="op">&lt;=</span> <span class="dv">2</span> <span class="op">*</span> pi<span class="op">;</span> w <span class="op">+=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        glVertex3f<span class="op">(</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                position<span class="op">.</span>x<span class="op">()</span> <span class="op">+</span> <span class="bu">std::</span>cos<span class="op">(</span>w<span class="op">)</span> <span class="op">*</span> radius<span class="op">,</span> </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                position<span class="op">.</span>y<span class="op">()</span> <span class="op">+</span> <span class="bu">std::</span>sin<span class="op">(</span>w<span class="op">)</span> <span class="op">*</span> radius<span class="op">,</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                depth<span class="op">);</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> drawCircleFilled<span class="op">(</span><span class="at">const</span> Vec2<span class="op">&amp;</span> position<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> radius<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> depth <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    glBegin<span class="op">(</span>GL_POLYGON<span class="op">);</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    drawCircle<span class="op">(</span>position<span class="op">,</span> radius<span class="op">,</span> depth<span class="op">);</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    glEnd<span class="op">();</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> drawCircleWire<span class="op">(</span><span class="at">const</span> Vec2<span class="op">&amp;</span> position<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> radius<span class="op">,</span> <span class="at">const</span> Scalar<span class="op">&amp;</span> depth <span class="op">=</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    glBegin<span class="op">(</span>GL_LINE_LOOP<span class="op">);</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    drawCircle<span class="op">(</span>position<span class="op">,</span> radius<span class="op">,</span> depth<span class="op">);</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    glEnd<span class="op">();</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> display<span class="op">()</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="dt">bool</span> first_run <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">constexpr</span> <span class="dt">float</span> dot_radius <span class="op">=</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    Scalar r_q <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    JzAzBzVec interpolated_jab<span class="op">{</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">};</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>first_run<span class="op">)</span> </span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>        interpolator<span class="op">.</span>dynamic_demos <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>        interpolator<span class="op">.</span>query<span class="op">(</span>q<span class="op">,</span> demo<span class="op">,</span> para<span class="op">,</span> meta<span class="op">,</span> interpolated_jab<span class="op">);</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>        interpolator<span class="op">.</span>dynamic_demos <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>        first_run <span class="op">=</span> <span class="kw">false</span><span class="op">;</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    interpolator<span class="op">.</span>query<span class="op">(</span>q<span class="op">,</span> demo<span class="op">,</span> para<span class="op">,</span> meta<span class="op">,</span> interpolated_jab<span class="op">);</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    r_q <span class="op">=</span> interpolator<span class="op">.</span>r_q<span class="op">;</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    RGBVec q_color <span class="op">=</span> JzAzBz_to_RGB<span class="op">(</span>interpolated_jab<span class="op">);</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>    glClear<span class="op">(</span>GL_COLOR_BUFFER_BIT <span class="op">|</span> GL_DEPTH_BUFFER_BIT<span class="op">);</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>size_t<span class="op"> </span>n<span class="op">;</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> n <span class="op">&lt;</span> N_<span class="op">;</span> <span class="op">++</span>n<span class="op">)</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> d <span class="op">=</span> demo<span class="op">[</span>n<span class="op">];</span></span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> m <span class="op">=</span> meta<span class="op">[</span>n<span class="op">];</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> v <span class="op">=</span> d<span class="op">.</span>s<span class="op">;</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// draw disk for weight</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>        glColor4f<span class="op">(</span>m<span class="op">.</span>w<span class="op">,</span> m<span class="op">.</span>w<span class="op">,</span> m<span class="op">.</span>w<span class="op">,</span> m<span class="op">.</span>w<span class="op">);</span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>        drawCircleFilled<span class="op">(</span>v<span class="op">,</span> m<span class="op">.</span>w<span class="op">/</span><span class="dv">3</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> n <span class="op">&lt;</span> N_<span class="op">;</span> <span class="op">++</span>n<span class="op">)</span></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> d <span class="op">=</span> demo<span class="op">[</span>n<span class="op">];</span></span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> m <span class="op">=</span> meta<span class="op">[</span>n<span class="op">];</span></span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> v <span class="op">=</span> d<span class="op">.</span>s<span class="op">;</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span> c <span class="op">=</span> JzAzBz_to_RGB<span class="op">(</span>d<span class="op">.</span>p<span class="op">);</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span> r <span class="op">=</span> m<span class="op">.</span>r <span class="op">&lt;</span> m<span class="op">.</span>d <span class="op">?</span> m<span class="op">.</span>r <span class="op">:</span> m<span class="op">.</span>d<span class="op">;</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">// draw radial circle</span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>        glColor3f<span class="op">(</span>c<span class="op">.</span>x<span class="op">(),</span> c<span class="op">.</span>y<span class="op">(),</span> c<span class="op">.</span>z<span class="op">());</span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>        drawCircleWire<span class="op">(</span>v<span class="op">,</span> r<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>        drawCircleWire<span class="op">(</span>v<span class="op">,</span> r <span class="op">-</span> <span class="fl">0.001</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> d <span class="op">:</span> demo<span class="op">)</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span><span class="op">&amp;</span> v <span class="op">=</span> d<span class="op">.</span>s<span class="op">;</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">const</span> <span class="kw">auto</span> c <span class="op">=</span> JzAzBz_to_RGB<span class="op">(</span>d<span class="op">.</span>p<span class="op">);</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>        <span class="co">// draw colored dots</span></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>        glColor3f<span class="op">(</span>c<span class="op">.</span>x<span class="op">(),</span> c<span class="op">.</span>y<span class="op">(),</span> c<span class="op">.</span>z<span class="op">());</span></span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>        drawCircleFilled<span class="op">(</span>v<span class="op">,</span> dot_radius<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>    glColor3f<span class="op">(</span>q_color<span class="op">.</span>x<span class="op">(),</span> q_color<span class="op">.</span>y<span class="op">(),</span> q_color<span class="op">.</span>z<span class="op">());</span></span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>    drawCircleWire<span class="op">(</span>q<span class="op">,</span> r_q<span class="op">);</span></span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>    drawCircleWire<span class="op">(</span>q<span class="op">,</span> r_q <span class="op">-</span> <span class="fl">0.001</span><span class="op">);</span></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>    drawCircleFilled<span class="op">(</span>q<span class="op">,</span> dot_radius<span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>    glutSwapBuffers<span class="op">();</span></span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>All of the points in the scene in world coordinates are in the square region ([0 - 1], [0 - 1]). The reshape callback appropriately sets the viewport and projection matrices to ensure this region is visible and undistorted. In case the window is wider than it is tall, padding is added on the sides so that the scene is centered. Otherwise, when the window is taller than it is wide, the padding is added above and below the scene.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;reshape callback&#39;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> reshape<span class="op">(</span><span class="dt">int</span> w<span class="op">,</span> <span class="dt">int</span> h<span class="op">)</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    glViewport<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span>w<span class="op">,</span>h<span class="op">);</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    glMatrixMode<span class="op">(</span>GL_PROJECTION<span class="op">);</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    glLoadIdentity<span class="op">();</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>h <span class="op">&lt;</span> w<span class="op">)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>   <span class="co">// the window is a wide rectangle</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>h <span class="op">&lt;</span> w<span class="op">:</span> calculate pixels_per_unit <span class="kw">and</span> offset<span class="op">}</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        glOrtho<span class="op">(-</span>offset<span class="op">,</span> <span class="dv">1</span> <span class="op">+</span> offset<span class="op">,</span> <span class="dv">0</span><span class="op">,</span>       <span class="dv">1</span><span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>   <span class="co">// the window is a tall rectangle (or square)</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>w <span class="op">&lt;=</span> h<span class="op">:</span> calculate pixels_per_unit <span class="kw">and</span> offset<span class="op">}</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>        glOrtho<span class="op">(</span><span class="dv">0</span><span class="op">,</span>       <span class="dv">1</span><span class="op">,</span>          <span class="op">-</span>offset<span class="op">,</span> <span class="dv">1</span> <span class="op">+</span> offset<span class="op">,</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;h &lt; w: calculate pixels_per_unit and offset&#39;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>Scalar padding <span class="op">=</span> <span class="op">(</span>w <span class="op">-</span> h<span class="op">)/</span><span class="dv">2</span><span class="op">;</span> <span class="co">// there is `padding` space on either size of the scene square</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>Scalar pixels_per_unit <span class="op">=</span> h<span class="op">;</span> <span class="co">// this many pixels per unit in world coordinates</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>Scalar units_per_pixel <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>pixels_per_unit<span class="op">;</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>Scalar offset <span class="op">=</span> padding <span class="op">*</span> units_per_pixel<span class="op">;</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;w &lt;= h: calculate pixels_per_unit and offset&#39;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>Scalar padding <span class="op">=</span> <span class="op">(</span>h <span class="op">-</span> w<span class="op">)/</span><span class="dv">2</span><span class="op">;</span> <span class="co">// there is `padding` space above and below the scene square</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>Scalar pixels_per_unit <span class="op">=</span> w<span class="op">;</span> <span class="co">// this many pixels per unit in world coordinates</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>Scalar units_per_pixel <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>pixels_per_unit<span class="op">;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>Scalar offset <span class="op">=</span> padding <span class="op">*</span> units_per_pixel<span class="op">;</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>The position of the query vector <code>q</code> is updated in the mouse move callback. This requires a similar calculation as the reshape callback, only going the other direction.</p>
<p>This callback also drives updates to the display, since moving the cursor will change the state of the interpolator.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;motion callback&#39;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> mouse_move<span class="op">(</span><span class="dt">int</span> x<span class="op">,</span> <span class="dt">int</span> y<span class="op">)</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> glutGet<span class="op">(</span>GLUT_WINDOW_HEIGHT<span class="op">)</span> <span class="op">-</span> y<span class="op">;</span> <span class="co">// flip y so it goes from the bottom left</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> w <span class="op">=</span> glutGet<span class="op">(</span>GLUT_WINDOW_WIDTH<span class="op">);</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> h <span class="op">=</span> glutGet<span class="op">(</span>GLUT_WINDOW_HEIGHT<span class="op">);</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>h <span class="op">&lt;</span> w<span class="op">)</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>   <span class="co">// the window is a wide rectangle</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>h <span class="op">&lt;</span> w<span class="op">:</span> calculate pixels_per_unit <span class="kw">and</span> offset<span class="op">}</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>        q<span class="op">.</span>x<span class="op">()</span> <span class="op">=</span> <span class="op">(</span>Scalar<span class="op">)</span>x <span class="op">/</span> pixels_per_unit <span class="op">-</span> offset<span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>        q<span class="op">.</span>y<span class="op">()</span> <span class="op">=</span> <span class="op">(</span>Scalar<span class="op">)</span>y <span class="op">/</span> pixels_per_unit<span class="op">;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span>   <span class="co">// the window is a tall rectangle (or square)</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="er">@</span><span class="op">{</span>w <span class="op">&lt;=</span> h<span class="op">:</span> calculate pixels_per_unit <span class="kw">and</span> offset<span class="op">}</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        q<span class="op">.</span>x<span class="op">()</span> <span class="op">=</span> <span class="op">(</span>Scalar<span class="op">)</span>x <span class="op">/</span> pixels_per_unit<span class="op">;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>        q<span class="op">.</span>y<span class="op">()</span> <span class="op">=</span> <span class="op">(</span>Scalar<span class="op">)</span>y <span class="op">/</span> pixels_per_unit <span class="op">-</span> offset<span class="op">;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    glutPostRedisplay<span class="op">();</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>The rest of the program is basically boilerplate for setting up openGL. The global <code>using</code> declarations are the same as in the drawing example, as is the subroutine for generating random demonstrations.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;setup display and callbacks&#39;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">// fake argv and argc since we can&#39;t access the real ones behind fire-hpp</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span> fake_argv<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>string<span class="op"> </span>prog_name <span class="op">=</span> <span class="st">&quot;interactive_colors&quot;</span><span class="op">;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>fake_argv<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">&amp;*</span>prog_name<span class="op">.</span>begin<span class="op">();</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fake_argc <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>glutInit<span class="op">(&amp;</span>fake_argc<span class="op">,</span> fake_argv<span class="op">);</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>glutInitDisplayMode<span class="op">(</span>GLUT_DOUBLE <span class="op">|</span> GLUT_RGBA<span class="op">);</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>glutInitWindowPosition<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>glutInitWindowSize<span class="op">(</span><span class="dv">500</span><span class="op">,</span><span class="dv">500</span><span class="op">);</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>glutCreateWindow<span class="op">(</span><span class="st">&quot;Interactive Interpolator Demo&quot;</span><span class="op">);</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>glutMotionFunc<span class="op">(</span>mouse_move<span class="op">);</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>glutPassiveMotionFunc<span class="op">(</span>mouse_move<span class="op">);</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>glutDisplayFunc<span class="op">(</span>display<span class="op">);</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>glutReshapeFunc<span class="op">(</span>reshape<span class="op">);</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>glEnable<span class="op">(</span>GL_DEPTH_TEST<span class="op">);</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>glClearColor<span class="op">(</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>glClear<span class="op">(</span>GL_COLOR_BUFFER_BIT<span class="op">);</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>glutSwapBuffers<span class="op">();</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @#&#39;examples/interactive_colors.cpp&#39;</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string&gt;</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;chrono&gt;</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;random&gt;</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;GL/gl.h&gt;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;GL/glut.h&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Eigen/Core&gt;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;Eigen/LU&gt;</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;include/fire-hpp/fire.hpp&quot;</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;../interpolator/marier_spheres.h&quot;</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>basic globals<span class="op">}</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> interpolator <span class="op">=</span> Interp<span class="op">::</span>IntersectingNSpheres<span class="op">{};</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span>Interp<span class="op">::</span>Demo<span class="op">&gt;</span> demo<span class="op">;</span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>vector<span class="op">&lt;</span>Interp<span class="op">::</span>IntersectingNSpheres<span class="op">::</span>Meta<span class="op">&gt;</span> meta<span class="op">;</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> <span class="op">*</span> para<span class="op">;</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>Vec2 q <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>size_t<span class="op"> </span>N_<span class="op">;</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>colour conversions<span class="op">}</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>display callback<span class="op">}</span></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>reshape callback<span class="op">}</span></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>motion callback<span class="op">}</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fired_main<span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> N <span class="op">=</span> fire<span class="op">::</span>arg<span class="op">(</span><span class="st">&quot;n&quot;</span><span class="op">,</span> <span class="st">&quot;The number of demonstrations&quot;</span><span class="op">,</span> <span class="dv">5</span><span class="op">))</span></span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    N_ <span class="op">=</span> N<span class="op">;</span></span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>generate random demonstrations<span class="op">}</span></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>    meta<span class="op">.</span>resize<span class="op">(</span>demo<span class="op">.</span>size<span class="op">());</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>setup display <span class="kw">and</span> callbacks<span class="op">}</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    glutMainLoop<span class="op">();</span></span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>FIRE<span class="op">(</span>fired_main<span class="op">)</span></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h2 id="converting-rgb-to-perceptually-uniform-colour-space">Converting RGB to perceptually uniform colour space</h2>
<p>As mentioned above, the interpolator in the drawing example uses a perceptually uniform colour space called J_zA_zB_z to ensure that the topology of the interpolator is well represented by the image without distortion by the non-linear relationship of the colour representation to typical human colour vision. Since the colours are rendered in RGB, it is necessary to convert RGB to and from J_zA_zB_z It is assumed that the RGB colour values will be interpreted and displayed by the system as <a href="https://en.wikipedia.org/wiki/SRGB">sRGB</a>, a reasonable default assumption due to the ubiquitous use of this standard colour space on the web, OpenGL, and other standards and consumer optical equipment. Both sRGB and J_zA_zB_z colour spaces are defined relative to <a href="https://en.wikipedia.org/wiki/CIE_1931_color_space">CIE XYZ</a> colour space, a standard colour space defined by the International Commission on Illumination in 1931 that defines a quantitative representation of the physiological response of the eye as it relates to the perception of a certain colour. Given this shared root, converting to or from sRGB to J_zA_zB_z requires first converting to or from CIE XYZ. We assume that the sRGB values are normalized between 0.0 and 1.0, that the CIE XYZ Y value ranges between 0.0 and 1.0.</p>
<p>The conversion between sRGB and CIE XYZ is given in <a href="https://en.wikipedia.org/wiki/SRGB">the wikipedia page on sRGB</a>. Since the example programs make use of Eigen for their colour data, the conversion can be succinctly implemented with matrix multiplication and other Eigen features.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;RGB - XYZ colour conversions&#39;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>RGBVec XYZ_to_RGB<span class="op">(</span><span class="at">const</span> CIEXYZVec<span class="op">&amp;</span> xyz<span class="op">)</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    RGBVec rgb<span class="op">;</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Matrix3f a<span class="op">;</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;&lt;</span>  <span class="fl">3.24096994</span><span class="op">,</span> <span class="op">-</span><span class="fl">1.53738318</span><span class="op">,</span> <span class="op">-</span><span class="fl">0.49861076</span><span class="op">,</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>         <span class="op">-</span><span class="fl">0.96924364</span><span class="op">,</span>  <span class="fl">1.8759675</span><span class="op">,</span>   <span class="fl">0.04155506</span><span class="op">,</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>          <span class="fl">0.05563008</span><span class="op">,</span> <span class="op">-</span><span class="fl">0.20397696</span><span class="op">,</span>  <span class="fl">1.05697151</span><span class="op">;</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    rgb <span class="op">=</span> a <span class="op">*</span> xyz<span class="op">;</span> <span class="co">// apply linear transformation</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> <span class="co">// apply gamme correction</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> u <span class="op">=</span> rgb<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> u <span class="op">&gt;</span> <span class="fl">0.0031308</span> <span class="op">?</span> <span class="op">(</span><span class="fl">1.055</span> <span class="op">*</span> pow<span class="op">(</span>u<span class="op">,</span> <span class="dv">1</span> <span class="op">/</span> <span class="fl">2.4</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.055</span><span class="op">)</span> <span class="op">:</span> <span class="fl">12.92</span> <span class="op">*</span> u<span class="op">;</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> u <span class="op">&lt;</span> <span class="fl">0.0</span> <span class="op">?</span> <span class="fl">0.0</span> <span class="op">:</span> u<span class="op">;</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> u <span class="op">&gt;</span> <span class="fl">1.0</span> <span class="op">?</span> <span class="fl">1.0</span> <span class="op">:</span> u<span class="op">;</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        rgb<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> u<span class="op">;</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rgb<span class="op">;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>CIEXYZVec RGB_to_XYZ<span class="op">(</span><span class="at">const</span> RGBVec<span class="op">&amp;</span> rgb<span class="op">)</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>    CIEXYZVec xyz <span class="op">=</span> rgb<span class="op">;</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Matrix3f a<span class="op">;</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    a <span class="op">&lt;&lt;</span>  <span class="fl">0.41239080</span><span class="op">,</span>  <span class="fl">0.35758434</span><span class="op">,</span>  <span class="fl">0.18048079</span><span class="op">,</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>          <span class="fl">0.21263901</span><span class="op">,</span>  <span class="fl">0.71516868</span><span class="op">,</span>  <span class="fl">0.07219232</span><span class="op">,</span></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>          <span class="fl">0.01933082</span><span class="op">,</span>  <span class="fl">0.11919478</span><span class="op">,</span>  <span class="fl">0.95053215</span><span class="op">;</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> i<span class="op">++)</span> <span class="co">// reverse gamme correction</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> u <span class="op">=</span> xyz<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>        u <span class="op">=</span> u <span class="op">&gt;</span> <span class="fl">0.04045</span> <span class="op">?</span> pow<span class="op">((</span>u <span class="op">+</span> <span class="fl">0.055</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1.055</span><span class="op">,</span> <span class="fl">2.4</span><span class="op">)</span> <span class="op">:</span> u <span class="op">/</span> <span class="fl">12.92</span><span class="op">;</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>        xyz<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> u<span class="op">;</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">*</span> xyz<span class="op">;</span> <span class="co">// reverse linear transformation</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>The conversion between J_zA_zB_z and CIE XYZ is given in <a href="https://doi.org/10.1364/OE.25.015131">the 2017 paper by Safdar et al. introducing J_zA_zB_z published by the Optical Society of America in Volume 25 Issue 13 pages 15131-15151 of the journal Optics Express</a>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;JzAzBz consts&#39;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="at">const</span> Eigen<span class="op">::</span>Matrix3f M1 <span class="op">=</span> <span class="op">(</span>Eigen<span class="op">::</span>Matrix3f<span class="op">()</span> <span class="op">&lt;&lt;</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.41478972</span><span class="op">,</span>  <span class="fl">0.579999</span><span class="op">,</span>  <span class="fl">0.0146480</span><span class="op">,</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span><span class="fl">0.2015100</span><span class="op">,</span>  <span class="fl">1.120649</span><span class="op">,</span>  <span class="fl">0.0531008</span><span class="op">,</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span><span class="fl">0.0166008</span><span class="op">,</span>  <span class="fl">0.264800</span><span class="op">,</span>  <span class="fl">0.6684799</span><span class="op">).</span>finished<span class="op">();</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="at">const</span> Eigen<span class="op">::</span>Matrix3f M2 <span class="op">=</span> <span class="op">(</span>Eigen<span class="op">::</span>Matrix3f<span class="op">()</span> <span class="op">&lt;&lt;</span>  </span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.5</span><span class="op">,</span>         <span class="fl">0.5</span><span class="op">,</span>       <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="fl">3.524000</span><span class="op">,</span>   <span class="op">-</span><span class="fl">4.066708</span><span class="op">,</span>  <span class="fl">0.542708</span><span class="op">,</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    <span class="fl">0.199076</span><span class="op">,</span>    <span class="fl">1.096799</span><span class="op">,</span> <span class="op">-</span><span class="fl">1.295875</span><span class="op">).</span>finished<span class="op">();</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> two5 <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> two7 <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">7</span><span class="op">;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> two12 <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">12</span><span class="op">;</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> two14 <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">14</span><span class="op">;</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> b <span class="op">=</span> <span class="fl">1.15</span><span class="op">;</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> g <span class="op">=</span> <span class="fl">0.66</span><span class="op">;</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> c1 <span class="op">=</span> <span class="fl">3424.0</span> <span class="op">/</span> two12<span class="op">;</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> c2 <span class="op">=</span> <span class="fl">2413.0</span> <span class="op">/</span> two7<span class="op">;</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> c3 <span class="op">=</span> <span class="fl">2392.0</span> <span class="op">/</span> two7<span class="op">;</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> n <span class="op">=</span> <span class="fl">2610.0</span> <span class="op">/</span> two14<span class="op">;</span></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> p <span class="op">=</span> <span class="fl">1.7</span> <span class="op">*</span> <span class="fl">2523.0</span> <span class="op">/</span> two5<span class="op">;</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> d <span class="op">=</span> <span class="op">-</span><span class="fl">0.56</span><span class="op">;</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="dt">float</span> d_0 <span class="op">=</span> <span class="fl">1.6295499532821566e-11</span><span class="op">;</span></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;JzAzBz - XYZ colour conversions&#39;</span></span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>JzAzBzVec XYZ_to_JzAzBz<span class="op">(</span><span class="at">const</span> CIEXYZVec<span class="op">&amp;</span> xyz<span class="op">)</span></span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>JzAzBz consts<span class="op">}</span></span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> x <span class="op">=</span> xyz<span class="op">.</span>x<span class="op">();</span></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> y <span class="op">=</span> xyz<span class="op">.</span>y<span class="op">();</span></span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> z <span class="op">=</span> xyz<span class="op">.</span>z<span class="op">();</span></span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">// pre-adjust to improve iso-hue linearity (Safdar et al. eqn. 8</span></span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">x_</span> <span class="op">=</span> b <span class="op">*</span> x <span class="op">-</span> <span class="op">(</span>b <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> z<span class="op">;</span></span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">y_</span> <span class="op">=</span> g <span class="op">*</span> y <span class="op">-</span> <span class="op">(</span>g <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>    CIEXYZVec <span class="va">xyz_</span><span class="op">(</span><span class="va">x_</span><span class="op">,</span> <span class="va">y_</span><span class="op">,</span> z<span class="op">);</span></span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// transform xyz to cone primaries (Safdar et al. eqn. 9)</span></span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Vector3f lms <span class="op">=</span> M1 <span class="op">*</span> <span class="va">xyz_</span><span class="op">;</span></span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    <span class="co">// perceptual quantizer (Safdar et al. eqn. 10</span></span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb21-43"><a href="#cb21-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb21-44"><a href="#cb21-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> u <span class="op">=</span> pow<span class="op">(</span>lms<span class="op">[</span>i<span class="op">]</span> <span class="op">/</span> <span class="fl">10000.0</span><span class="op">,</span> n<span class="op">);</span></span>
<span id="cb21-45"><a href="#cb21-45" aria-hidden="true" tabindex="-1"></a>        lms<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> pow<span class="op">(</span> <span class="op">(</span>c1 <span class="op">+</span> c2 <span class="op">*</span> u<span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> c3 <span class="op">*</span> u<span class="op">),</span> p <span class="op">);</span></span>
<span id="cb21-46"><a href="#cb21-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-47"><a href="#cb21-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-48"><a href="#cb21-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// transform to correlates of opponent colour space (Safdar et al. eqn. 11)</span></span>
<span id="cb21-49"><a href="#cb21-49" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Vector3f jab <span class="op">=</span> M2 <span class="op">*</span> lms<span class="op">;</span></span>
<span id="cb21-50"><a href="#cb21-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-51"><a href="#cb21-51" aria-hidden="true" tabindex="-1"></a>    <span class="co">// improve wide-range lightness prediction (Safdar et al. eqn. 12)</span></span>
<span id="cb21-52"><a href="#cb21-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> i <span class="op">=</span> jab<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb21-53"><a href="#cb21-53" aria-hidden="true" tabindex="-1"></a>    jab<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> <span class="op">((</span><span class="fl">1.0</span> <span class="op">+</span> d<span class="op">)</span> <span class="op">*</span> i<span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> d <span class="op">*</span> i<span class="op">)</span> <span class="op">-</span> d_0<span class="op">;</span></span>
<span id="cb21-54"><a href="#cb21-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-55"><a href="#cb21-55" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> jab<span class="op">;</span></span>
<span id="cb21-56"><a href="#cb21-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-57"><a href="#cb21-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-58"><a href="#cb21-58" aria-hidden="true" tabindex="-1"></a>CIEXYZVec JzAzBz_to_XYZ<span class="op">(</span><span class="at">const</span> JzAzBzVec<span class="op">&amp;</span> jab<span class="op">)</span></span>
<span id="cb21-59"><a href="#cb21-59" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb21-60"><a href="#cb21-60" aria-hidden="true" tabindex="-1"></a>    <span class="er">@</span><span class="op">{</span>JzAzBz consts<span class="op">}</span></span>
<span id="cb21-61"><a href="#cb21-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="at">const</span> Eigen<span class="op">::</span>Matrix3f M1inv <span class="op">=</span> M1<span class="op">.</span>inverse<span class="op">();</span></span>
<span id="cb21-62"><a href="#cb21-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">static</span> <span class="at">const</span> Eigen<span class="op">::</span>Matrix3f M2inv <span class="op">=</span> M2<span class="op">.</span>inverse<span class="op">();</span></span>
<span id="cb21-63"><a href="#cb21-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-64"><a href="#cb21-64" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 17</span></span>
<span id="cb21-65"><a href="#cb21-65" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> iab <span class="op">=</span> jab<span class="op">;</span></span>
<span id="cb21-66"><a href="#cb21-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> j <span class="op">=</span> jab<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">+</span> d_0<span class="op">;</span></span>
<span id="cb21-67"><a href="#cb21-67" aria-hidden="true" tabindex="-1"></a>    iab<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> j <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">+</span> d <span class="op">-</span> d <span class="op">*</span> j<span class="op">);</span></span>
<span id="cb21-68"><a href="#cb21-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-69"><a href="#cb21-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 18</span></span>
<span id="cb21-70"><a href="#cb21-70" aria-hidden="true" tabindex="-1"></a>    Eigen<span class="op">::</span>Vector3f lms <span class="op">=</span> M2inv <span class="op">*</span> iab<span class="op">;</span></span>
<span id="cb21-71"><a href="#cb21-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-72"><a href="#cb21-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 19</span></span>
<span id="cb21-73"><a href="#cb21-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">3</span><span class="op">;</span> <span class="op">++</span>i<span class="op">)</span></span>
<span id="cb21-74"><a href="#cb21-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">{</span></span>
<span id="cb21-75"><a href="#cb21-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">auto</span> u <span class="op">=</span> pow<span class="op">(</span>lms<span class="op">[</span>i<span class="op">],</span> <span class="fl">1.0</span><span class="op">/</span>p<span class="op">);</span></span>
<span id="cb21-76"><a href="#cb21-76" aria-hidden="true" tabindex="-1"></a>        lms<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="fl">10000.0</span> <span class="op">*</span> pow<span class="op">(</span> <span class="op">(</span>c1 <span class="op">-</span> u<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>c3 <span class="op">*</span> u <span class="op">-</span> c2<span class="op">),</span> <span class="fl">1.0</span><span class="op">/</span>n <span class="op">);</span></span>
<span id="cb21-77"><a href="#cb21-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb21-78"><a href="#cb21-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-79"><a href="#cb21-79" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 20</span></span>
<span id="cb21-80"><a href="#cb21-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">xyz_</span> <span class="op">=</span> M1inv <span class="op">*</span> lms<span class="op">;</span></span>
<span id="cb21-81"><a href="#cb21-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-82"><a href="#cb21-82" aria-hidden="true" tabindex="-1"></a>    <span class="co">// eqn. 21 - 23</span></span>
<span id="cb21-83"><a href="#cb21-83" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">x_</span> <span class="op">=</span> <span class="va">xyz_</span><span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb21-84"><a href="#cb21-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">y_</span> <span class="op">=</span> <span class="va">xyz_</span><span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb21-85"><a href="#cb21-85" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> <span class="va">z_</span> <span class="op">=</span> <span class="va">xyz_</span><span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb21-86"><a href="#cb21-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> x <span class="op">=</span> <span class="op">(</span><span class="va">x_</span> <span class="op">+</span> <span class="op">(</span>b <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> <span class="va">z_</span><span class="op">)</span> <span class="op">/</span> b<span class="op">;</span></span>
<span id="cb21-87"><a href="#cb21-87" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> y <span class="op">=</span> <span class="op">(</span><span class="va">y_</span> <span class="op">+</span> <span class="op">(</span>g <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> x<span class="op">)</span> <span class="op">/</span> g<span class="op">;</span></span>
<span id="cb21-88"><a href="#cb21-88" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> z <span class="op">=</span> <span class="va">z_</span><span class="op">;</span></span>
<span id="cb21-89"><a href="#cb21-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-90"><a href="#cb21-90" aria-hidden="true" tabindex="-1"></a>    CIEXYZVec xyz<span class="op">{</span>x<span class="op">,</span> y<span class="op">,</span> z<span class="op">};</span></span>
<span id="cb21-91"><a href="#cb21-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> xyz<span class="op">;</span></span>
<span id="cb21-92"><a href="#cb21-92" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb21-93"><a href="#cb21-93" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<p>The conversion between sRGB and J_zA_zB_z is then easily implemented in terms of the above conversions to and from CIE XYZ colour space:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">// @=&#39;colour conversions&#39;</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>RGB <span class="op">-</span> XYZ colour conversions<span class="op">}</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="er">@</span><span class="op">{</span>JzAzBz <span class="op">-</span> XYZ colour conversions<span class="op">}</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>JzAzBzVec RGB_to_JzAzBz<span class="op">(</span><span class="at">const</span> RGBVec<span class="op">&amp;</span> rgb<span class="op">)</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> XYZ_to_JzAzBz<span class="op">(</span>RGB_to_XYZ<span class="op">(</span>rgb<span class="op">));</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>RGBVec JzAzBz_to_RGB<span class="op">(</span><span class="at">const</span> JzAzBzVec<span class="op">&amp;</span> jab<span class="op">)</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> XYZ_to_RGB<span class="op">(</span>JzAzBz_to_XYZ<span class="op">(</span>jab<span class="op">));</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">// @/</span></span></code></pre></div>
<h2 id="compiling-examples">Compiling Examples</h2>
<p>Both examples are relatively simple with just a few dependencies. Both rely on Eigen, and the interactive example additionally requires OpenGL. Make sure that these libraries are installed on your system. The other dependencies (fire-hpp and bitmap) are both included as subtrees in this repository, so you should not have to do anything to install them.</p>
<p>A simple Makefile is included in this repository with rules for building the examples, as well as for generating the machine source code and pretty-printed source code from this literate source code document using <a href="https://github.com/DocSunset/lilit"><code>lilit</code></a>. The Makefile is tested and working on the author’s Arch Linux system. As usual, I am open to recommendations and pull requests to improve the compatibility of the Makefile.</p>
</body>
</html>
